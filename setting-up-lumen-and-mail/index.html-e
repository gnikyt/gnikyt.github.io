<!DOCTYPE html>
<html>
<head>
	<!-- Theme: Attila by zutrinken, powered by: Ghost -->
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />

	<title>Setting Up Lumen + Mailer</title>

	<meta name="HandheldFriendly" content="True" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />

	<link rel="stylesheet" type="text/css" href="../assets/css/style.css?v=4f8314772c" />

	<link rel="shortcut icon" href="../favicon.png" type="image/png" />
    <link rel="canonical" href="index.html" />
    <meta name="referrer" content="no-referrer-when-downgrade" />
    <link rel="amphtml" href="amp/index.html" />
    
    <meta property="og:site_name" content="OhMyBrew!" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="Setting Up Lumen + Mailer" />
    <meta property="og:description" content="What is Lumen? Lumen is a micro-framework built by Laravel. Its geared towards small services like APIs, job handling, or very small projects. Laravel is all-inclusive, where as Lumen is bare-bones but still featured. Setting Up Mailing Recently I ported a small app from Sinatra to Lumen for trial with" />
    <meta property="og:url" content="https://ohmybrew.com/setting-up-lumen-and-mail/" />
    <meta property="og:image" content="https://images.unsplash.com/photo-1492539161849-b2b18e79c85f?ixlib&#x3D;rb-0.3.5&amp;q&#x3D;80&amp;fm&#x3D;jpg&amp;crop&#x3D;entropy&amp;cs&#x3D;tinysrgb&amp;w&#x3D;1080&amp;fit&#x3D;max&amp;ixid&#x3D;eyJhcHBfaWQiOjExNzczfQ&amp;s&#x3D;343f6a516fbc5c1ff243dd16dc1a8a16" />
    <meta property="article:published_time" content="2017-11-19T11:04:33.000Z" />
    <meta property="article:modified_time" content="2018-02-21T16:40:30.000Z" />
    <meta property="article:tag" content="php" />
    <meta property="article:tag" content="laravel" />
    <meta property="article:tag" content="lumen" />
    <meta property="article:tag" content="programming" />
    <meta property="article:tag" content="tip" />
    
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Setting Up Lumen + Mailer" />
    <meta name="twitter:description" content="What is Lumen? Lumen is a micro-framework built by Laravel. Its geared towards small services like APIs, job handling, or very small projects. Laravel is all-inclusive, where as Lumen is bare-bones but still featured. Setting Up Mailing Recently I ported a small app from Sinatra to Lumen for trial with" />
    <meta name="twitter:url" content="https://ohmybrew.com/setting-up-lumen-and-mail/" />
    <meta name="twitter:image" content="https://images.unsplash.com/photo-1492539161849-b2b18e79c85f?ixlib&#x3D;rb-0.3.5&amp;q&#x3D;80&amp;fm&#x3D;jpg&amp;crop&#x3D;entropy&amp;cs&#x3D;tinysrgb&amp;w&#x3D;1080&amp;fit&#x3D;max&amp;ixid&#x3D;eyJhcHBfaWQiOjExNzczfQ&amp;s&#x3D;343f6a516fbc5c1ff243dd16dc1a8a16" />
    <meta name="twitter:label1" content="Written by" />
    <meta name="twitter:data1" content="Tyler King" />
    <meta name="twitter:label2" content="Filed under" />
    <meta name="twitter:data2" content="php, laravel, lumen, programming, tip" />
    <meta property="og:image:width" content="1080" />
    <meta property="og:image:height" content="720" />
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "OhMyBrew!",
        "logo": {
            "@type": "ImageObject",
            "url": "https://ohmybrew.com/favicon.png",
            "width": 60,
            "height": 60
        }
    },
    "author": {
        "@type": "Person",
        "name": "Tyler King",
        "image": {
            "@type": "ImageObject",
            "url": "//www.gravatar.com/avatar/b866d161c9f02b7384a0940cb07135bc?s=250&d=mm&r=x",
            "width": 250,
            "height": 250
        },
        "url": "https://ohmybrew.com/author/tyler-king/",
        "sameAs": [
            "https://ohmybrew.com"
        ]
    },
    "headline": "Setting Up Lumen + Mailer",
    "url": "https://ohmybrew.com/setting-up-lumen-and-mail/",
    "datePublished": "2017-11-19T11:04:33.000Z",
    "dateModified": "2018-02-21T16:40:30.000Z",
    "image": {
        "@type": "ImageObject",
        "url": "https://images.unsplash.com/photo-1492539161849-b2b18e79c85f?ixlib=rb-0.3.5&q=80&fm=jpg&crop=entropy&cs=tinysrgb&w=1080&fit=max&ixid=eyJhcHBfaWQiOjExNzczfQ&s=343f6a516fbc5c1ff243dd16dc1a8a16",
        "width": 1080,
        "height": 720
    },
    "keywords": "php, laravel, lumen, programming, tip",
    "description": "What is Lumen? Lumen is a micro-framework built by Laravel. Its geared towards small services like APIs, job handling, or very small projects. Laravel is all-inclusive, where as Lumen is bare-bones but still featured. Setting Up Mailing Recently I ported a small app from Sinatra to Lumen for trial with",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://ohmybrew.com/"
    }
}
    </script>

    <script type="text/javascript" src="../public/ghost-sdk.js?v=4f8314772c"></script>
<script type="text/javascript">
ghost.init({
	clientId: "ghost-frontend",
	clientSecret: "af2244026b4c"
});
</script>
    <meta name="generator" content="Ghost 1.21" />
    <link rel="alternate" type="application/rss+xml" title="OhMyBrew!" href="../rss/index.html" />
    <script async src="https://www.google-analytics.com/analytics.js"></script>
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-101589108-1', 'auto');
    ga('send', 'pageview');
</script>
</head>

<body class="post-template tag-php tag-laravel-2 tag-lumen tag-programming tag-tip">
	
	<nav id="menu">
	<a class="close-button">Close</a>
	<div class="nav-wrapper">
		<p class="nav-label">Menu</p>
		<ul>
			<li class="nav-home" role="presentation"><a href="../index.html">Home</a></li>
			<li class="nav-github" role="presentation"><a href="https://github.com/ohmybrew"><i class="ic ic-star"></i> Github</a></li>
			
			<li class="nav-rss"><a href="../rss/index.html"><i class="ic ic-rss"></i> Subscribe</a></li>
		</ul>
	</div>
</nav>
	
	<section id="wrapper">
		<a class="hidden-close"></a>
		

<div class="progress-container">
	<span class="progress-bar"></span>
</div>

<header id="post-header" class="has-cover" >
	<div class="inner">
		<nav id="navigation">
			<span id="home-button" class="nav-button">
				<a class="home-button" href="../index.html" title="Home"><i class="ic ic-arrow-left"></i> Home</a>
			</span>
			<span id="menu-button" class="nav-button">
				<a class="menu-button"><i class="ic ic-menu"></i> Menu</a>
			</span>
		</nav>
		<h1 class="post-title">Setting Up Lumen + Mailer</h1>
		<span class="post-meta"><a href="../author/tyler-king/index.html">Tyler King</a> | <time datetime="2017-11-19">19 Nov 2017</time></span>
		<div class="post-cover cover" style="background-image: url('https://images.unsplash.com/photo-1492539161849-b2b18e79c85f?ixlib&#x3D;rb-0.3.5&amp;q&#x3D;80&amp;fm&#x3D;jpg&amp;crop&#x3D;entropy&amp;cs&#x3D;tinysrgb&amp;w&#x3D;1080&amp;fit&#x3D;max&amp;ixid&#x3D;eyJhcHBfaWQiOjExNzczfQ&amp;s&#x3D;343f6a516fbc5c1ff243dd16dc1a8a16');"></div>
	</div>
</header>

<main class="content" role="main">
	<article class="post tag-php tag-laravel-2 tag-lumen tag-programming tag-tip">
		<div class="inner">

			<section class="post-content">
				<div class="kg-card-markdown"><h2 id="whatislumen">What is Lumen?</h2>
<p><a href="https://lumen.laravel.com/">Lumen</a> is a micro-framework built by Laravel. Its geared towards small services like APIs, job handling, or very small projects. Laravel is all-inclusive, where as Lumen is bare-bones but still featured.</p>
<h2 id="settingupmailing">Setting Up Mailing</h2>
<p>Recently I ported a small app from Sinatra to Lumen for trial with a client. Its a job processing app for Shopify, where it would take data from a web hook, process it with a worker, and send back some data later. It needed to be fast, as like other webhook-focused app, it has to keep up with the high demand.</p>
<p>One issue I ran into was mailing, its not enabled by default in Lumen, and there are many posts throughout Google of people attempting to set it up. There is also many outdated ways which only worked for old version of Lumen.</p>
<p>Through trial and error, I managed to find a working setup I thought I would share.</p>
<h3 id="setup">Setup</h3>
<p>First, run <code>composer require illuminate/mail:5.5</code> to grab the mailing component.</p>
<p>Next, open <code>bootstrap/app.php</code>, find <code>$app-&gt;register(App\Providers\AppServiceProvider::class);</code> and uncomment it, if not already.</p>
<p>After this is done, open the app provider in <code>app/Providers/</code>.</p>
<p>At the bottom of the <code>register</code> method, paste in the following:</p>
<pre><code class="language-php">&lt;?php
// ...

// Init mailer
$this-&gt;app-&gt;singleton(
    'mailer',
    function ($app) {
        return $app-&gt;loadComponent('mail', 'Illuminate\Mail\MailServiceProvider', 'mailer');
    }
);

// Aliases
$this-&gt;app-&gt;alias('mailer', \Illuminate\Contracts\Mail\Mailer::class);
</code></pre>
<p>To make mailing queue-able and able to be processed in the background, simply add:</p>
<pre><code class="language-php">&lt;?php
// ...

// Enable queues
$this-&gt;app-&gt;make('queue');  
</code></pre>
<p>And see my Lumen Redis tutorial to setup Redis for processing.</p>
<p>Next, setup the basic config <code>config/mail.php</code>:</p>
<pre><code class="language-php">&lt;?php

return [
    'driver' =&gt; env('MAIL_DRIVER'),
    'host' =&gt; env('MAIL_HOST'),
    'port' =&gt; env('MAIL_PORT'),
    'from' =&gt; [
        'address' =&gt; env('MAIL_FROM_ADDRESS'),
        'name' =&gt; env('MAIL_FROM_NAME'),
    ],
    'encryption' =&gt; env('MAIL_ENCRYPTION'),
    'username' =&gt; env('MAIL_USERNAME'),
    'password' =&gt; env('MAIL_PASSWORD'),
    'markdown' =&gt; [
        'theme' =&gt; 'default',
        'paths' =&gt; [
            resource_path('views/vendor/mail'),
        ],
    ],
];

</code></pre>
<p>That's it, you're done the setup! Don't forget to setup your environment variables for production.</p>
<h3 id="creatingamailer">Creating a Mailer</h3>
<p>Now that we're setup, you can create a mailer in <code>app/Mail/</code>, heres an example to go by (<code>app/Mail/Winnings</code>):</p>
<pre><code class="language-php">&lt;?php namespace App\Mail;

use Illuminate\Bus\Queueable;
use Illuminate\Mail\Mailable;
use Illuminate\Queue\SerializesModels;

class Winnings extends Mailable
{
    use Queueable, SerializesModels;

    /** @var string the address to send the email */
    protected $to_address;

    /** @var float the winnings they won */
    protected $winnings;

    /**
     * Create a new message instance.
     *
     * @param string $to_address the address to send the email
     * @param float $winnings   the winnings they won
     * 
     * @return void
     */
    public function __construct($to_address, $winnings)
    {
        $this-&gt;to_address = $to_address;
        $this-&gt;winnings = $winnings;
    }

    /**
     * Build the message.
     *
     * @return $this
     */
    public function build()
    {
        return $this
            -&gt;to($this-&gt;to_address)
            -&gt;subject('Your winnings!')
            -&gt;view('emails.winnings')
            -&gt;with(
                [
                    'winnings' =&gt; $this-&gt;winnings
                ]
            );
    }
}

</code></pre>
<p>Now, create a view, <code>resources/views/emails/winnings.blade.php</code> for simply HTML-only,:</p>
<pre><code class="language-html">{% raw %}&lt;strong&gt;You won {{ $winnings }}&lt;/strong&gt;!{% endraw %}
</code></pre>
<h2 id="sendingmail">Sending Mail</h2>
<p>Now that we have it setup, and a mailable created, we can send. In your job, controller, or where ever you need it:</p>
<pre><code class="language-php">&lt;?php
use App\Mail\Winnings as WinningsMail;

// ...
// $to_email = 'john@doe.com'; $winnings = 130.00;

Mail::send(
    new WinningsMail(
        $to_email,
        $winnings
    )
);
</code></pre>
<p>If you're queuing mail, replace <code>send</code> with <code>queue</code>. You can also see <a href="https://laravel.com/docs/5.5/mail#sending-mail">Laravel's mail documentation</a> for more information on sending.</p>
<h2 id="testing">Testing</h2>
<p>Of course, we need to test (<code>tests/WinningsMailTest.php</code>):</p>
<pre><code class="language-php">&lt;?php

use App\Mail\Winnings;
use Illuminate\Support\Facades\Mail;

class WinningsMailTest extends TestCase
{
    public function testItWorks()
    {
        Mail::fake();

        Mail::send(
            (new Winnings('john@doe.com', 15.00))-&gt;build()
        );

        Mail::assertSent(Winnings::class, function ($mail) {
            return $mail-&gt;hasTo('john@doe.com') &amp;&amp;
                   $mail-&gt;subject === 'Your winnings!' &amp;&amp;
                   $mail-&gt;viewData['winnings'] === 15.00;
        });
    }
}
</code></pre>
<p>Running the tests should pass if everything is setup correctly. For more information on testing mailables, see <a href="https://laravel.com/docs/5.5/mocking#mail-fake">Laravel's documentation on faking</a>.</p>
<p>I hope this was a quick and useful setup for anyone having issues. Good luck!</p>
<hr>
<p><em>Cover image credit: <a href="https://unsplash.com/photos/MYXf7tGEntk">Mikael Kristenson</a></em></p>
</div>
			</section>

			<section class="post-info">

				<div class="post-share">
					<a class="twitter" href="https://twitter.com/share?text=Setting Up Lumen + Mailer&url=https://ohmybrew.com/setting-up-lumen-and-mail/" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
						<i class="ic ic-twitter"></i><span class="hidden">Twitter</span>
					</a>
					<a class="facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://ohmybrew.com/setting-up-lumen-and-mail/" onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
						<i class="ic ic-facebook"></i><span class="hidden">Facebook</span>
					</a>
					<a class="googleplus" href="https://plus.google.com/share?url=https://ohmybrew.com/setting-up-lumen-and-mail/" onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
						<i class="ic ic-googleplus"></i><span class="hidden">Google+</span>
					</a>
					<div class="clear"></div>
				</div>

				<aside class="post-tags">
					<a href="../tag/php/index.html">php</a> <a href="../tag/laravel-2/index.html">laravel</a> <a href="../tag/lumen/index.html">lumen</a> <a href="../tag/programming/index.html">programming</a> <a href="../tag/tip/index.html">tip</a>
				</aside>

				<div class="clear"></div>

				<aside class="post-author">
					<figure class="post-author-avatar avatar">
							<img src="http://www.gravatar.com/avatar/b866d161c9f02b7384a0940cb07135bc?s=250&amp;d=mm&amp;r=x" alt="Tyler King" />
					</figure>
					<div class="post-author-bio">
						<h4 class="post-author-name"><a href="../author/tyler-king/index.html">Tyler King</a></h4>
							<p class="post-author-about">I'm a loving father, passionate homebrewer, motorcycle rider, and of course.. a coder. I develop solutions through experience.</p>
							<span class="post-author-location"><i class="ic ic-location"></i> Newfoundland</span>
							<span class="post-author-website"><i class="ic ic-link"></i> <a href="https://ohmybrew.com">Website</a></span>
					</div>
					<div class="clear"></div>
				</aside>

			</section>


			<section class="post-comments">
				<a id="show-disqus" class="post-comments-activate">Show Comments</a>
			    <div id="disqus_thread"></div>
			</section>


			<aside class="post-nav">
					<a class="post-nav-next" href="../setting-up-lumen-and-redis/index.html">
						<section class="post-nav-teaser">
							<i class="ic ic-arrow-left"></i>
							<h2 class="post-nav-title">Setting Up Lumen + Redis</h2>
							<p class="post-nav-excerpt">This is more of an extension of my previous post &quot;Setting&hellip;</p>
						</section>
					</a>
					<a class="post-nav-prev" href="../pomodoro-method/index.html">
						<section class="post-nav-teaser">
							<i class="ic ic-arrow-right"></i>
							<h2 class="post-nav-title">Pomodoro Method</h2>
							<p class="post-nav-excerpt">I've had a history of a bad back and neck, ever since&hellip;</p>
						</section>
					</a>
				<div class="clear"></div>
			</aside>


		</div>
	</article>
</main>


		<div id="body-class" style="display: none;" class="post-template tag-php tag-laravel-2 tag-lumen tag-programming tag-tip"></div>
	
		<footer id="footer">
			<div class="inner">
			</div>
		</footer>
	</section>

	<script type="text/javascript" src="../assets/js/script.js?v=4f8314772c"></script>

	
</body>
</html>
