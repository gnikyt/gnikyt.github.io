<!--
  Hello! Lookin' for something? Well... it was built quickly, hope thats OK with you!
  https://github.com/gnikyt/gnikyt.github.io
-->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1" name="viewport">
    <title>
      Handling Shopify API limits and Goroutines | gnikyt
    </title>
    <link href="https://gnikyt.com/handling-shopify-api-limits-goroutines" rel="canonical">
    <meta content="Custom" name="generator">
    <meta content=
    "I frequently build integration applications with Shopify and I thought it would be helpful to highlight one approach (of many) that I co..."
    name="description">
    <meta content="2025-04-10T16:26:22-0230" property="article:published_time">
    <meta content="Handling Shopify API limits and Goroutines" property="og:title">
    <meta content="en" property="og:locale">
    <meta content=
    "I frequently build integration applications with Shopify and I thought it would be helpful to highlight one approach (of many) that I co..."
    property="og:description">
    <meta content="https://gnikyt.com/handling-shopify-api-limits-goroutines" property="og:url">
    <meta content="gnikyt" property="og:site_name">
    <meta content="article" property="og:type">
    <meta content="summary" name="twitter:card">
    <meta content=
    "I frequently build integration applications with Shopify and I thought it would be helpful to highlight one approach (of many) that I co..."
    property="twitter:title">
    <script type="application/ld+json">
    {
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "dateModified": "2025-04-10T16:26:22-0230",
    "datePublished": "2025-04-10T16:26:22-0230",
    "description": "
    I frequently build integration applications with Shopify and I thought it would be helpful to highlight one approach (of many) that I co...",
    "headline": "Handling Shopify API limits and Goroutines",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "https://gnikyt.com/handling-shopify-api-limits-goroutines"
    },
    "publisher": {
      "@type": "Organization",
      "logo": {
        "@type": "ImageObject",
        "url": "https://gnikyt.com/assets/favicon-32x32.png"
      }
    },
    "url": "https://gnikyt.com/handling-shopify-api-limits-goroutines"
    }
    </script>
    <link as="font" crossorigin="anonymous" href="/assets/fonts/RobotoMono-Regular.woff2" rel="preload" type=
    "font/woff2">
    <link as="font" crossorigin="anonymous" href="/assets/fonts/RobotoMono-Bold.woff2" rel="preload" type="font/woff2">
    <link as="font" crossorigin="anonymous" href="/assets/fonts/RobotoMono-Light.woff2" rel="preload" type=
    "font/woff2">
    <link href="/assets/images/favicon.ico" rel="shortcut icon" type="image/x-icon">
    <link href="/assets/images/favicon.png" rel="icon" sizes="32x32" type="image/png">
    <link href="/rss.xml" rel="alternate" title="gnikyt feed" type="application/rss+xml">
    <link href="/assets/styles/style.css" rel="stylesheet">
    <link href="/assets/styles/highlight.css" rel="stylesheet">
  </head>
  <body class="layout layout--post" data-handle="handling-shopify-api-limits-goroutines">
    <header class="site-head container">
      <span class="site-head__item"><a class="site-head__link" href="/">gnikyt</a></span> <span class=
      "site-head__item site-head__item--tag"><span>&nbsp;&nbsp;</span>/&nbsp;&nbsp;Code ramblings</span>
    </header>

    <main class="container">
      <article class="tab post">
        <header class="post__head">
          <h1 class="tab__title tab__title--short post__title">
            Handling Shopify API limits and Goroutines /
          </h1>
        </header>

        <div class="tab__container">
          <div class="tab__content">
            <div class="post__meta content-container">
              <div class="post__details">
                /* <time class="post__time" datetime="2025-04-10">Apr 10,
                2025</time>&nbsp;&nbsp;—&nbsp;&nbsp;<span class="post__size">15KB</span> */
              </div>

              <div class="post__category">
                <a href="/category/golang"><img alt="Logo of golang" class="post__category-logo" src=
                "/assets/images/category-golang.svg"></a><a href="/category/shopify"><img alt="Logo of shopify" class=
                "post__category-logo" src="/assets/images/category-shopify.svg"></a>
              </div>
            </div>

            <div class="content-container">
              <p>
                I frequently build integration applications with Shopify and I thought it would be helpful to highlight
                one approach (of many) that I commonly use for handling API rate limits with Shopify’s GraphQL API
                using Go. The integration in question was originally developed and maintained by a third-party
                provider. However, after their company was acquired, they decided to shut down their service and stop
                all servicing of the integration. Now it would be needed to be rebuilt from scratch.
              </p>

              <p>
                The original integration worked by accepting a standardized CSV file from a third-party service through
                a webhook. The CSV file contained a list of SKUs and their current inventory levels, which needed to be
                synced with the Shopify store. This same CSV format was used by the service for multiple merchants at
                once and typically contained between 3,000–3,500 rows. Not every SKU in the CSV necessarily existed in
                the store, so that had to be accounted for during processing.
              </p>

              <p>
                In summary, the rebuild of the integration had to handle the following:
              </p>

              <ol type="1">
                <li>Read each line from the CSV
                </li>

                <li>Check if the SKU exists in the store
                </li>

                <li>If it does, update its inventory to the specified value
                </li>
              </ol>

              <p>
                Format example of the CSV:
              </p>

              <pre class="csv"><code>ITEM_CODE,QTY
00288,5
22991,1
23211,18
...</code></pre>
              <p>
                Additionally, Shopify’s GraphQL API limits would obviously be high priority to factor in. In the case
                for this specific Shopify store, the limits were:
              </p>

              <ul>
                <li>2000 available points
                </li>

                <li>100 points refilled per second
                </li>
              </ul>

              <p>
                Each row in the CSV required one to two GraphQL calls to Shopify, depending on whether the SKU existed
                in the store. A query was needed to fetch the SKU, and if it was found, a mutation followed which would
                update the inventory.
              </p>

              <p>
                By analyzing the query and mutation costs in Shopify’s GraphQL app, it was determined that each query
                consumed 2 points, while each mutation consumed 10 points. This meant, in the worst case senario, where
                every SKU existed, a total of 12 points would be consumed per row.
              </p>

              <p>
                My goal was to maximize the number of concurrent queries and mutations without blowing through the
                available points too quickly. At the same time, maintain a safeguard to throttle requests if the point
                threshold was reached, allowing time for points to refill and ensuring the updates could continue
                without having a bad request returned by Shopify.
              </p>

              <p>
                With the point consumption determined, I previously developed a script to simulate depleating the
                available points, which I reused for this project. I modified the simulation script to depleat the
                available points by 12, multiplied by a different number concurrent running updates, while also
                increasing the available points at a rate of 100 points per second. This simulation script also kept
                track of the number of requests happening per second.
              </p>

              <p>
                The result of this simulation with a different number of potential concurrent running updates, I came
                to the conclusion that between 15-20 concurrent jobs would be a safe balance; potientially draining 180
                points per second or more and refilling at a rate of 100 per second, would result in an average net
                decrease of 80 points per second from the available points. Given a safeguard would be in place to
                handle potentially hitting the threshold of available points, this was a great balance to continue
                with.
              </p>

              <p>
                Now, there are several methods a developer can take to craft a solution preventing draining the
                available points down to zero… some developers may call each job in sequence, some developers may call
                each job with a sleep in between, some developers may run it as a batch of jobs in sequence, some
                developers may utilize a worker pool system with a set capacity, etc.
              </p>

              <p>
                For me, I decided to develop a semaphore approach. If you’re not familiar with that, a semaphore is
                essentially a concurrency control method to maintain a set capacity of “how many” of something is
                permitted to run at a time. A process would first “aquire” a spot and when completed it’s work, it
                would “release” the spot, so another process can aquire it.
              </p>

              <p>
                Since there would be between 3,000-3,500 rows in the CSV (on average), I decided to skip a worker pool
                setup and simply spin up each row of the CSV as a Goroutine, where each Goroutine would attempt to
                aquire a spot with the semaphore control and upon release of that spot, we would check the remaining
                available points and handle accordingly.
              </p>

              <p>
                Additionally, the capacity of this semaphore would be set to the 15-20 limit previously determined from
                the simulated script. If the remaining available points dipped below a set threshold, the release
                mechanism would cause a “pause” in releasing, calculating the time it would take to refill the
                available points back to maximum, then resuming the release. This would allow 15-20 concurrent jobs to
                be running at a time, while the release mechanism acted as the safe guard to ensure the available
                points were not totally drained.
              </p>

              <p>
                Example code is below.
              </p>

              <div class="sourceCode" id="cb2">
                <pre class="sourceCode go"><code class="sourceCode go"><span id="cb2-1"><a aria-hidden="true" href=
                "#cb2-1" tabindex="-1"></a><span class="kw">package</span> shopifysemaphore</span>
<span id="cb2-2"><a aria-hidden="true" href="#cb2-2" tabindex="-1"></a></span>
<span id="cb2-3"><a aria-hidden="true" href="#cb2-3" tabindex="-1"></a><span class="kw">import</span> <span class=
"op">(</span></span>
<span id="cb2-4"><a aria-hidden="true" href="#cb2-4" tabindex="-1"></a>    <span class="st">"sync/atomic"</span></span>
<span id="cb2-5"><a aria-hidden="true" href="#cb2-5" tabindex="-1"></a>    <span class="st">"time"</span></span>
<span id="cb2-6"><a aria-hidden="true" href="#cb2-6" tabindex="-1"></a><span class="op">)</span></span>
<span id="cb2-7"><a aria-hidden="true" href="#cb2-7" tabindex="-1"></a></span>
<span id="cb2-8"><a aria-hidden="true" href="#cb2-8" tabindex="-1"></a><span class=
"co">// ErrPts is the points value to pass in if a network or other error happens.</span></span>
<span id="cb2-9"><a aria-hidden="true" href="#cb2-9" tabindex="-1"></a><span class=
"co">// Essentially to be used for situations where no response containing point</span></span>
<span id="cb2-10"><a aria-hidden="true" href="#cb2-10" tabindex="-1"></a><span class=
"co">// information was returned. This is used to know if the Update method should</span></span>
<span id="cb2-11"><a aria-hidden="true" href="#cb2-11" tabindex="-1"></a><span class=
"co">// actually update the remaining point balance or not.</span></span>
<span id="cb2-12"><a aria-hidden="true" href="#cb2-12" tabindex="-1"></a><span class=
"kw">var</span> ErrPts <span class="dt">int32</span> <span class="op">=</span> <span class="op">-</span><span class=
"dv">1</span></span>
<span id="cb2-13"><a aria-hidden="true" href="#cb2-13" tabindex="-1"></a></span>
<span id="cb2-14"><a aria-hidden="true" href="#cb2-14" tabindex="-1"></a><span class=
"co">// Balance represents the information of point values and keeps track of</span></span>
<span id="cb2-15"><a aria-hidden="true" href="#cb2-15" tabindex="-1"></a><span class=
"co">// items such as the remaining points, threshold, limit, and refill rate.</span></span>
<span id="cb2-16"><a aria-hidden="true" href="#cb2-16" tabindex="-1"></a><span class=
"kw">type</span> Balance <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb2-17"><a aria-hidden="true" href="#cb2-17" tabindex="-1"></a>    Remaining  atomic<span class=
"op">.</span>Int32 <span class="co">// Point balance remaining.</span></span>
<span id="cb2-18"><a aria-hidden="true" href="#cb2-18" tabindex="-1"></a>    Threshold  <span class=
"dt">int32</span>        <span class=
"co">// Minimum point balance where we would consider handling with a "pause".</span></span>
<span id="cb2-19"><a aria-hidden="true" href="#cb2-19" tabindex="-1"></a>    Limit      <span class=
"dt">int32</span>        <span class="co">// Maximum points available.</span></span>
<span id="cb2-20"><a aria-hidden="true" href="#cb2-20" tabindex="-1"></a>    RefillRate <span class=
"dt">int32</span>        <span class="co">// Number of points refilled per second.</span></span>
<span id="cb2-21"><a aria-hidden="true" href="#cb2-21" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb2-22"><a aria-hidden="true" href="#cb2-22" tabindex="-1"></a></span>
<span id="cb2-23"><a aria-hidden="true" href="#cb2-23" tabindex="-1"></a><span class=
"co">// NewBalance accepts a threshold (thld) point balance, a maximum (max) point</span></span>
<span id="cb2-24"><a aria-hidden="true" href="#cb2-24" tabindex="-1"></a><span class=
"co">// balance, and the refill rate (rr). It will return a pointer to Balance.</span></span>
<span id="cb2-25"><a aria-hidden="true" href="#cb2-25" tabindex="-1"></a><span class=
"kw">func</span> NewBalance<span class="op">(</span>thld <span class="dt">int32</span><span class=
"op">,</span> max <span class="dt">int32</span><span class="op">,</span> rr <span class="dt">int32</span><span class=
"op">)</span> <span class="op">*</span>Balance <span class="op">{</span></span>
<span id="cb2-26"><a aria-hidden="true" href="#cb2-26" tabindex="-1"></a>    b <span class="op">:=</span> <span class=
"op">&</span>Balance<span class="op">{</span></span>
<span id="cb2-27"><a aria-hidden="true" href="#cb2-27" tabindex="-1"></a>        Threshold<span class=
"op">:</span>  thld<span class="op">,</span></span>
<span id="cb2-28"><a aria-hidden="true" href="#cb2-28" tabindex="-1"></a>        Limit<span class=
"op">:</span>      max<span class="op">,</span></span>
<span id="cb2-29"><a aria-hidden="true" href="#cb2-29" tabindex="-1"></a>        RefillRate<span class=
"op">:</span> rr<span class="op">,</span></span>
<span id="cb2-30"><a aria-hidden="true" href="#cb2-30" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb2-31"><a aria-hidden="true" href="#cb2-31" tabindex="-1"></a>    b<span class=
"op">.</span>Update<span class="op">(</span>max<span class="op">)</span></span>
<span id="cb2-32"><a aria-hidden="true" href="#cb2-32" tabindex="-1"></a>    <span class="cf">return</span> b</span>
<span id="cb2-33"><a aria-hidden="true" href="#cb2-33" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb2-34"><a aria-hidden="true" href="#cb2-34" tabindex="-1"></a></span>
<span id="cb2-35"><a aria-hidden="true" href="#cb2-35" tabindex="-1"></a><span class=
"co">// Update accepts a new value of remaining points to store.</span></span>
<span id="cb2-36"><a aria-hidden="true" href="#cb2-36" tabindex="-1"></a><span class="kw">func</span> <span class=
"op">(</span>b <span class="op">*</span>Balance<span class="op">)</span> Update<span class=
"op">(</span>points <span class="dt">int32</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-37"><a aria-hidden="true" href="#cb2-37" tabindex="-1"></a>    <span class=
"cf">if</span> points <span class="op">&gt;</span> ErrPts <span class="op">{</span></span>
<span id="cb2-38"><a aria-hidden="true" href="#cb2-38" tabindex="-1"></a>        b<span class=
"op">.</span>Remaining<span class="op">.</span>Store<span class="op">(</span>points<span class="op">)</span></span>
<span id="cb2-39"><a aria-hidden="true" href="#cb2-39" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb2-40"><a aria-hidden="true" href="#cb2-40" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb2-41"><a aria-hidden="true" href="#cb2-41" tabindex="-1"></a></span>
<span id="cb2-42"><a aria-hidden="true" href="#cb2-42" tabindex="-1"></a><span class=
"co">// RefillDuration accounts for the remaining points, the limit, and the refill rate to</span></span>
<span id="cb2-43"><a aria-hidden="true" href="#cb2-43" tabindex="-1"></a><span class=
"co">// determine how many seconds it would take to refill to remaining points back to full.</span></span>
<span id="cb2-44"><a aria-hidden="true" href="#cb2-44" tabindex="-1"></a><span class=
"co">// It will return a duration which can be used to "pause" operations.</span></span>
<span id="cb2-45"><a aria-hidden="true" href="#cb2-45" tabindex="-1"></a><span class="kw">func</span> <span class=
"op">(</span>b <span class="op">*</span>Balance<span class="op">)</span> RefillDuration<span class=
"op">()</span> time<span class="op">.</span>Duration <span class="op">{</span></span>
<span id="cb2-46"><a aria-hidden="true" href="#cb2-46" tabindex="-1"></a>    <span class=
"cf">return</span> time<span class="op">.</span>Duration<span class="op">((</span>b<span class=
"op">.</span>Limit<span class="op">-</span>b<span class="op">.</span>Remaining<span class="op">.</span>Load<span class=
"op">())/</span>b<span class="op">.</span>RefillRate<span class="op">)</span> <span class=
"op">*</span> time<span class="op">.</span>Second</span>
<span id="cb2-47"><a aria-hidden="true" href="#cb2-47" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb2-48"><a aria-hidden="true" href="#cb2-48" tabindex="-1"></a></span>
<span id="cb2-49"><a aria-hidden="true" href="#cb2-49" tabindex="-1"></a><span class=
"co">// AtThreshold will return a boolean if we have reached or surpassed the set</span></span>
<span id="cb2-50"><a aria-hidden="true" href="#cb2-50" tabindex="-1"></a><span class=
"co">// threshold of remaining points or not.</span></span>
<span id="cb2-51"><a aria-hidden="true" href="#cb2-51" tabindex="-1"></a><span class="kw">func</span> <span class=
"op">(</span>b <span class="op">*</span>Balance<span class="op">)</span> AtThreshold<span class=
"op">()</span> <span class="dt">bool</span> <span class="op">{</span></span>
<span id="cb2-52"><a aria-hidden="true" href="#cb2-52" tabindex="-1"></a>    <span class=
"cf">return</span> b<span class="op">.</span>Remaining<span class="op">.</span>Load<span class=
"op">()</span> <span class="op">&lt;=</span> b<span class="op">.</span>Threshold</span>
<span id="cb2-53"><a aria-hidden="true" href="#cb2-53" tabindex="-1"></a><span class="op">}</span></span></code></pre>
              </div>

              <div class="sourceCode" id="cb3">
                <pre class="sourceCode go"><code class="sourceCode go"><span id="cb3-1"><a aria-hidden="true" href=
                "#cb3-1" tabindex="-1"></a><span class="kw">package</span> shopifysemaphore</span>
<span id="cb3-2"><a aria-hidden="true" href="#cb3-2" tabindex="-1"></a></span>
<span id="cb3-3"><a aria-hidden="true" href="#cb3-3" tabindex="-1"></a><span class="kw">import</span> <span class=
"op">(</span></span>
<span id="cb3-4"><a aria-hidden="true" href="#cb3-4" tabindex="-1"></a>    <span class="st">"context"</span></span>
<span id="cb3-5"><a aria-hidden="true" href="#cb3-5" tabindex="-1"></a>    <span class="st">"sync"</span></span>
<span id="cb3-6"><a aria-hidden="true" href="#cb3-6" tabindex="-1"></a>    <span class="st">"time"</span></span>
<span id="cb3-7"><a aria-hidden="true" href="#cb3-7" tabindex="-1"></a><span class="op">)</span></span>
<span id="cb3-8"><a aria-hidden="true" href="#cb3-8" tabindex="-1"></a></span>
<span id="cb3-9"><a aria-hidden="true" href="#cb3-9" tabindex="-1"></a><span class="kw">var</span> <span class=
"op">(</span></span>
<span id="cb3-10"><a aria-hidden="true" href="#cb3-10" tabindex="-1"></a>    DefaultAquireBuffer <span class=
"op">=</span> <span class="dv">200</span> <span class="op">*</span> time<span class=
"op">.</span>Millisecond <span class="co">// Default aquire throttle duration.</span></span>
<span id="cb3-11"><a aria-hidden="true" href="#cb3-11" tabindex="-1"></a>    DefaultPauseBuffer  <span class=
"op">=</span> <span class="dv">1</span> <span class="op">*</span> time<span class=
"op">.</span>Second        <span class=
"co">// Default pause buffer to append to pause duration calculation.</span></span>
<span id="cb3-12"><a aria-hidden="true" href="#cb3-12" tabindex="-1"></a><span class="op">)</span></span>
<span id="cb3-13"><a aria-hidden="true" href="#cb3-13" tabindex="-1"></a></span>
<span id="cb3-14"><a aria-hidden="true" href="#cb3-14" tabindex="-1"></a><span class=
"co">// Semaphore is responsible regulating when to pause and resume processing of Goroutines.</span></span>
<span id="cb3-15"><a aria-hidden="true" href="#cb3-15" tabindex="-1"></a><span class=
"co">// Points remaining, point thresholds, and point refill rates are taken into</span></span>
<span id="cb3-16"><a aria-hidden="true" href="#cb3-16" tabindex="-1"></a><span class=
"co">// consideration. If remaining points go below the threshold, a pause is initiated</span></span>
<span id="cb3-17"><a aria-hidden="true" href="#cb3-17" tabindex="-1"></a><span class=
"co">// which will also calculate how long a pause should happen based on the refill rate.</span></span>
<span id="cb3-18"><a aria-hidden="true" href="#cb3-18" tabindex="-1"></a><span class=
"co">// Once pause is completed, the processing will resume. A PauceFunc and ResumeFunc</span></span>
<span id="cb3-19"><a aria-hidden="true" href="#cb3-19" tabindex="-1"></a><span class=
"co">// can optionally be passed in which will fire respectively when a pause happens</span></span>
<span id="cb3-20"><a aria-hidden="true" href="#cb3-20" tabindex="-1"></a><span class=
"co">// and when a resume happens.</span></span>
<span id="cb3-21"><a aria-hidden="true" href="#cb3-21" tabindex="-1"></a><span class=
"kw">type</span> Semaphore <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb3-22"><a aria-hidden="true" href="#cb3-22" tabindex="-1"></a>    <span class=
"op">*</span>Balance <span class="co">// Point information and tracking.</span></span>
<span id="cb3-23"><a aria-hidden="true" href="#cb3-23" tabindex="-1"></a></span>
<span id="cb3-24"><a aria-hidden="true" href="#cb3-24" tabindex="-1"></a>    PauseFunc    <span class=
"kw">func</span><span class="op">(</span><span class="dt">int32</span><span class="op">,</span> time<span class=
"op">.</span>Duration<span class="op">)</span> <span class=
"co">// Optional callback for when pause happens.</span></span>
<span id="cb3-25"><a aria-hidden="true" href="#cb3-25" tabindex="-1"></a>    ResumeFunc   <span class=
"kw">func</span><span class="op">()</span>                     <span class=
"co">// Optional callback for when resume happens.</span></span>
<span id="cb3-26"><a aria-hidden="true" href="#cb3-26" tabindex="-1"></a>    PauseBuffer  time<span class=
"op">.</span>Duration              <span class=
"co">// Buffer of time to wait before attempting to re-aquire a spot.</span></span>
<span id="cb3-27"><a aria-hidden="true" href="#cb3-27" tabindex="-1"></a>    AquireBuffer time<span class=
"op">.</span>Duration              <span class="co">// Buffer of time to extend the pause with.</span></span>
<span id="cb3-28"><a aria-hidden="true" href="#cb3-28" tabindex="-1"></a></span>
<span id="cb3-29"><a aria-hidden="true" href="#cb3-29" tabindex="-1"></a>    pausedAt time<span class=
"op">.</span>Time     <span class="co">// When paused last happened.</span></span>
<span id="cb3-30"><a aria-hidden="true" href="#cb3-30" tabindex="-1"></a>    sema     <span class=
"kw">chan</span> <span class="kw">struct</span><span class="op">{}</span> <span class=
"co">// Semaphore for controlling the number of Goroutines running.</span></span>
<span id="cb3-31"><a aria-hidden="true" href="#cb3-31" tabindex="-1"></a></span>
<span id="cb3-32"><a aria-hidden="true" href="#cb3-32" tabindex="-1"></a>    mu     sync<span class=
"op">.</span>Mutex <span class="co">// For handling paused flag control.</span></span>
<span id="cb3-33"><a aria-hidden="true" href="#cb3-33" tabindex="-1"></a>    paused <span class=
"dt">bool</span>       <span class="co">// Pause flag.</span></span>
<span id="cb3-34"><a aria-hidden="true" href="#cb3-34" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb3-35"><a aria-hidden="true" href="#cb3-35" tabindex="-1"></a></span>
<span id="cb3-36"><a aria-hidden="true" href="#cb3-36" tabindex="-1"></a><span class=
"co">// NewSemaphore returns a pointer to Semaphore. It accepts a cap which represents the</span></span>
<span id="cb3-37"><a aria-hidden="true" href="#cb3-37" tabindex="-1"></a><span class=
"co">// capacity of how many Goroutines can run at a time, it also accepts information</span></span>
<span id="cb3-38"><a aria-hidden="true" href="#cb3-38" tabindex="-1"></a><span class=
"co">// about the point balance and lastly, optional parameters.</span></span>
<span id="cb3-39"><a aria-hidden="true" href="#cb3-39" tabindex="-1"></a><span class=
"kw">func</span> NewSemaphore<span class="op">(</span><span class="bu">cap</span> <span class=
"dt">int</span><span class="op">,</span> b <span class="op">*</span>Balance<span class="op">,</span> opts <span class=
"op">...</span><span class="kw">func</span><span class="op">(*</span>Semaphore<span class="op">))</span> <span class=
"op">*</span>Semaphore <span class="op">{</span></span>
<span id="cb3-40"><a aria-hidden="true" href="#cb3-40" tabindex="-1"></a>    sem <span class=
"op">:=</span> <span class="op">&</span>Semaphore<span class="op">{</span></span>
<span id="cb3-41"><a aria-hidden="true" href="#cb3-41" tabindex="-1"></a>        Balance<span class=
"op">:</span> b<span class="op">,</span></span>
<span id="cb3-42"><a aria-hidden="true" href="#cb3-42" tabindex="-1"></a>        sema<span class=
"op">:</span>    <span class="bu">make</span><span class="op">(</span><span class="kw">chan</span> <span class=
"kw">struct</span><span class="op">{},</span> <span class="bu">cap</span><span class="op">),</span></span>
<span id="cb3-43"><a aria-hidden="true" href="#cb3-43" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb3-44"><a aria-hidden="true" href="#cb3-44" tabindex="-1"></a>    <span class="cf">for</span> _<span class=
"op">,</span> opt <span class="op">:=</span> <span class="kw">range</span> opts <span class="op">{</span></span>
<span id="cb3-45"><a aria-hidden="true" href="#cb3-45" tabindex="-1"></a>        opt<span class=
"op">(</span>sem<span class="op">)</span></span>
<span id="cb3-46"><a aria-hidden="true" href="#cb3-46" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb3-47"><a aria-hidden="true" href="#cb3-47" tabindex="-1"></a>    <span class="cf">if</span> sem<span class=
"op">.</span>PauseFunc <span class="op">==</span> <span class="ot">nil</span> <span class="op">{</span></span>
<span id="cb3-48"><a aria-hidden="true" href="#cb3-48" tabindex="-1"></a>        <span class=
"co">// Provide default PauseFunc.</span></span>
<span id="cb3-49"><a aria-hidden="true" href="#cb3-49" tabindex="-1"></a>        WithPauseFunc<span class=
"op">(</span><span class="kw">func</span><span class="op">(</span>_ <span class="dt">int32</span><span class=
"op">,</span> _ time<span class="op">.</span>Duration<span class="op">)</span> <span class=
"op">{})(</span>sem<span class="op">)</span></span>
<span id="cb3-50"><a aria-hidden="true" href="#cb3-50" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb3-51"><a aria-hidden="true" href="#cb3-51" tabindex="-1"></a>    <span class="cf">if</span> sem<span class=
"op">.</span>ResumeFunc <span class="op">==</span> <span class="ot">nil</span> <span class="op">{</span></span>
<span id="cb3-52"><a aria-hidden="true" href="#cb3-52" tabindex="-1"></a>        <span class=
"co">// Provide default ResumeFunc.</span></span>
<span id="cb3-53"><a aria-hidden="true" href="#cb3-53" tabindex="-1"></a>        WithResumeFunc<span class=
"op">(</span><span class="kw">func</span><span class="op">()</span> <span class="op">{})(</span>sem<span class=
"op">)</span></span>
<span id="cb3-54"><a aria-hidden="true" href="#cb3-54" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb3-55"><a aria-hidden="true" href="#cb3-55" tabindex="-1"></a>    <span class="cf">if</span> sem<span class=
"op">.</span>AquireBuffer <span class="op">==</span> <span class="dv">0</span> <span class="op">{</span></span>
<span id="cb3-56"><a aria-hidden="true" href="#cb3-56" tabindex="-1"></a>        WithAquireBuffer<span class=
"op">(</span>DefaultAquireBuffer<span class="op">)(</span>sem<span class="op">)</span></span>
<span id="cb3-57"><a aria-hidden="true" href="#cb3-57" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb3-58"><a aria-hidden="true" href="#cb3-58" tabindex="-1"></a>    <span class="cf">return</span> sem</span>
<span id="cb3-59"><a aria-hidden="true" href="#cb3-59" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb3-60"><a aria-hidden="true" href="#cb3-60" tabindex="-1"></a></span>
<span id="cb3-61"><a aria-hidden="true" href="#cb3-61" tabindex="-1"></a><span class=
"co">// Aquire will attempt to aquire a spot to run the Goroutine.</span></span>
<span id="cb3-62"><a aria-hidden="true" href="#cb3-62" tabindex="-1"></a><span class=
"co">// It will continue in a loop until it does aquire also pausing</span></span>
<span id="cb3-63"><a aria-hidden="true" href="#cb3-63" tabindex="-1"></a><span class=
"co">// if the pause flag has been enabled. Aquiring is throttled at</span></span>
<span id="cb3-64"><a aria-hidden="true" href="#cb3-64" tabindex="-1"></a><span class=
"co">// the value of AquireBuffer.</span></span>
<span id="cb3-65"><a aria-hidden="true" href="#cb3-65" tabindex="-1"></a><span class="kw">func</span> <span class=
"op">(</span>sem <span class="op">*</span>Semaphore<span class="op">)</span> Aquire<span class=
"op">(</span>ctx context<span class="op">.</span>Context<span class="op">)</span> <span class=
"op">(</span>err <span class="dt">error</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-66"><a aria-hidden="true" href="#cb3-66" tabindex="-1"></a>    <span class=
"cf">for</span> aquired <span class="op">:=</span> <span class="ot">false</span><span class="op">;</span> <span class=
"op">!</span>aquired<span class="op">;</span> <span class="op">{</span></span>
<span id="cb3-67"><a aria-hidden="true" href="#cb3-67" tabindex="-1"></a>        <span class=
"cf">for</span> <span class="op">{</span></span>
<span id="cb3-68"><a aria-hidden="true" href="#cb3-68" tabindex="-1"></a>            <span class=
"cf">if</span> <span class="op">!</span>sem<span class="op">.</span>paused <span class="op">{</span></span>
<span id="cb3-69"><a aria-hidden="true" href="#cb3-69" tabindex="-1"></a>                <span class=
"co">// Not paused, break loop and attempt to aquire a spot.</span></span>
<span id="cb3-70"><a aria-hidden="true" href="#cb3-70" tabindex="-1"></a>                <span class=
"cf">break</span></span>
<span id="cb3-71"><a aria-hidden="true" href="#cb3-71" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb3-72"><a aria-hidden="true" href="#cb3-72" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb3-73"><a aria-hidden="true" href="#cb3-73" tabindex="-1"></a></span>
<span id="cb3-74"><a aria-hidden="true" href="#cb3-74" tabindex="-1"></a>        <span class=
"co">// Attempt to aquire a spot, if not we will throttle the next loop.</span></span>
<span id="cb3-75"><a aria-hidden="true" href="#cb3-75" tabindex="-1"></a>        <span class=
"cf">select</span> <span class="op">{</span></span>
<span id="cb3-76"><a aria-hidden="true" href="#cb3-76" tabindex="-1"></a>        <span class=
"cf">case</span> <span class="op">&lt;-</span>ctx<span class="op">.</span>Done<span class="op">():</span></span>
<span id="cb3-77"><a aria-hidden="true" href="#cb3-77" tabindex="-1"></a>            <span class=
"co">// Context done/cancelled, break loop, and return the error.</span></span>
<span id="cb3-78"><a aria-hidden="true" href="#cb3-78" tabindex="-1"></a>            aquired <span class=
"op">=</span> <span class="ot">true</span></span>
<span id="cb3-79"><a aria-hidden="true" href="#cb3-79" tabindex="-1"></a>            err <span class=
"op">=</span> ctx<span class="op">.</span>Err<span class="op">()</span></span>
<span id="cb3-80"><a aria-hidden="true" href="#cb3-80" tabindex="-1"></a>        <span class=
"cf">case</span> sem<span class="op">.</span>sema <span class="op">&lt;-</span> <span class=
"kw">struct</span><span class="op">{}{}:</span></span>
<span id="cb3-81"><a aria-hidden="true" href="#cb3-81" tabindex="-1"></a>            <span class=
"co">// Spot aquired, break loop.</span></span>
<span id="cb3-82"><a aria-hidden="true" href="#cb3-82" tabindex="-1"></a>            aquired <span class=
"op">=</span> <span class="ot">true</span></span>
<span id="cb3-83"><a aria-hidden="true" href="#cb3-83" tabindex="-1"></a>        <span class=
"cf">default</span><span class="op">:</span></span>
<span id="cb3-84"><a aria-hidden="true" href="#cb3-84" tabindex="-1"></a>            <span class=
"co">// Can not yet aquire a spot, throttle for a set duration.</span></span>
<span id="cb3-85"><a aria-hidden="true" href="#cb3-85" tabindex="-1"></a>            time<span class=
"op">.</span>Sleep<span class="op">(</span>sem<span class="op">.</span>AquireBuffer<span class="op">)</span></span>
<span id="cb3-86"><a aria-hidden="true" href="#cb3-86" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb3-87"><a aria-hidden="true" href="#cb3-87" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb3-88"><a aria-hidden="true" href="#cb3-88" tabindex="-1"></a>    <span class="cf">return</span></span>
<span id="cb3-89"><a aria-hidden="true" href="#cb3-89" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb3-90"><a aria-hidden="true" href="#cb3-90" tabindex="-1"></a></span>
<span id="cb3-91"><a aria-hidden="true" href="#cb3-91" tabindex="-1"></a><span class=
"co">// Release will release a spot for another Goroutine to take.</span></span>
<span id="cb3-92"><a aria-hidden="true" href="#cb3-92" tabindex="-1"></a><span class=
"co">// It accepts a current value of remaining point balance, to which the</span></span>
<span id="cb3-93"><a aria-hidden="true" href="#cb3-93" tabindex="-1"></a><span class=
"co">// remaining point balance will only be updated if the count is greater than -1.</span></span>
<span id="cb3-94"><a aria-hidden="true" href="#cb3-94" tabindex="-1"></a><span class=
"co">// If the remaining points is below the set threshold, a pause will be</span></span>
<span id="cb3-95"><a aria-hidden="true" href="#cb3-95" tabindex="-1"></a><span class=
"co">// initiated and a duration of this pause will be calculated based</span></span>
<span id="cb3-96"><a aria-hidden="true" href="#cb3-96" tabindex="-1"></a><span class=
"co">// upon several factors surrouding the point information such as limit,</span></span>
<span id="cb3-97"><a aria-hidden="true" href="#cb3-97" tabindex="-1"></a><span class=
"co">// threshold, and the refull rate.</span></span>
<span id="cb3-98"><a aria-hidden="true" href="#cb3-98" tabindex="-1"></a><span class="kw">func</span> <span class=
"op">(</span>sem <span class="op">*</span>Semaphore<span class="op">)</span> Release<span class=
"op">(</span>pts <span class="dt">int32</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-99"><a aria-hidden="true" href="#cb3-99" tabindex="-1"></a>    <span class=
"cf">defer</span> sem<span class="op">.</span>mu<span class="op">.</span>Unlock<span class="op">()</span></span>
<span id="cb3-100"><a aria-hidden="true" href="#cb3-100" tabindex="-1"></a>    sem<span class=
"op">.</span>mu<span class="op">.</span>Lock<span class="op">()</span></span>
<span id="cb3-101"><a aria-hidden="true" href="#cb3-101" tabindex="-1"></a></span>
<span id="cb3-102"><a aria-hidden="true" href="#cb3-102" tabindex="-1"></a>    sem<span class=
"op">.</span>Update<span class="op">(</span>pts<span class="op">)</span></span>
<span id="cb3-103"><a aria-hidden="true" href="#cb3-103" tabindex="-1"></a>    <span class=
"cf">if</span> sem<span class="op">.</span>AtThreshold<span class="op">()</span> <span class="op">{</span></span>
<span id="cb3-104"><a aria-hidden="true" href="#cb3-104" tabindex="-1"></a>        <span class=
"co">// Calculate the duration required to refill and that duration time</span></span>
<span id="cb3-105"><a aria-hidden="true" href="#cb3-105" tabindex="-1"></a>        <span class=
"co">// has passed before we call for a pause.</span></span>
<span id="cb3-106"><a aria-hidden="true" href="#cb3-106" tabindex="-1"></a>        ra <span class=
"op">:=</span> sem<span class="op">.</span>RefillDuration<span class="op">()</span> <span class=
"op">+</span> sem<span class="op">.</span>PauseBuffer</span>
<span id="cb3-107"><a aria-hidden="true" href="#cb3-107" tabindex="-1"></a>        <span class=
"cf">if</span> sem<span class="op">.</span>pausedAt<span class="op">.</span>Add<span class="op">(</span>ra<span class=
"op">).</span>Before<span class="op">(</span>time<span class="op">.</span>Now<span class="op">())</span> <span class=
"op">{</span></span>
<span id="cb3-108"><a aria-hidden="true" href="#cb3-108" tabindex="-1"></a>            sem<span class=
"op">.</span>paused <span class="op">=</span> <span class="ot">true</span></span>
<span id="cb3-109"><a aria-hidden="true" href="#cb3-109" tabindex="-1"></a>            sem<span class=
"op">.</span>pausedAt <span class="op">=</span> time<span class="op">.</span>Now<span class="op">()</span></span>
<span id="cb3-110"><a aria-hidden="true" href="#cb3-110" tabindex="-1"></a>            <span class=
"cf">go</span> sem<span class="op">.</span>PauseFunc<span class="op">(</span>pts<span class=
"op">,</span> ra<span class="op">)</span></span>
<span id="cb3-111"><a aria-hidden="true" href="#cb3-111" tabindex="-1"></a></span>
<span id="cb3-112"><a aria-hidden="true" href="#cb3-112" tabindex="-1"></a>            <span class=
"co">// Unflag as paused after the determined duration and run the ResumeFunc.</span></span>
<span id="cb3-113"><a aria-hidden="true" href="#cb3-113" tabindex="-1"></a>            <span class=
"cf">go</span> <span class="kw">func</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb3-114"><a aria-hidden="true" href="#cb3-114" tabindex="-1"></a>                time<span class=
"op">.</span>Sleep<span class="op">(</span>ra<span class="op">)</span></span>
<span id="cb3-115"><a aria-hidden="true" href="#cb3-115" tabindex="-1"></a>                sem<span class=
"op">.</span>paused <span class="op">=</span> <span class="ot">false</span></span>
<span id="cb3-116"><a aria-hidden="true" href="#cb3-116" tabindex="-1"></a>                sem<span class=
"op">.</span>ResumeFunc<span class="op">()</span></span>
<span id="cb3-117"><a aria-hidden="true" href="#cb3-117" tabindex="-1"></a>            <span class=
"op">}()</span></span>
<span id="cb3-118"><a aria-hidden="true" href="#cb3-118" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb3-119"><a aria-hidden="true" href="#cb3-119" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb3-120"><a aria-hidden="true" href="#cb3-120" tabindex="-1"></a></span>
<span id="cb3-121"><a aria-hidden="true" href="#cb3-121" tabindex="-1"></a>    <span class=
"co">// Perform the actual release.</span></span>
<span id="cb3-122"><a aria-hidden="true" href="#cb3-122" tabindex="-1"></a>    <span class=
"op">&lt;-</span>sem<span class="op">.</span>sema</span>
<span id="cb3-123"><a aria-hidden="true" href="#cb3-123" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb3-124"><a aria-hidden="true" href="#cb3-124" tabindex="-1"></a></span>
<span id="cb3-125"><a aria-hidden="true" href="#cb3-125" tabindex="-1"></a><span class=
"co">// withPauseFunc is a functional option for Semaphore to call when</span></span>
<span id="cb3-126"><a aria-hidden="true" href="#cb3-126" tabindex="-1"></a><span class=
"co">// a pause happens. The point balance remaining and the duration of</span></span>
<span id="cb3-127"><a aria-hidden="true" href="#cb3-127" tabindex="-1"></a><span class=
"co">// the pause will passed into the function.</span></span>
<span id="cb3-128"><a aria-hidden="true" href="#cb3-128" tabindex="-1"></a><span class=
"kw">func</span> WithPauseFunc<span class="op">(</span>fn <span class="kw">func</span><span class=
"op">(</span><span class="dt">int32</span><span class="op">,</span> time<span class="op">.</span>Duration<span class=
"op">))</span> <span class="kw">func</span><span class="op">(*</span>Semaphore<span class="op">)</span> <span class=
"op">{</span></span>
<span id="cb3-129"><a aria-hidden="true" href="#cb3-129" tabindex="-1"></a>    <span class=
"cf">return</span> <span class="kw">func</span><span class="op">(</span>sem <span class=
"op">*</span>Semaphore<span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-130"><a aria-hidden="true" href="#cb3-130" tabindex="-1"></a>        sem<span class=
"op">.</span>PauseFunc <span class="op">=</span> fn</span>
<span id="cb3-131"><a aria-hidden="true" href="#cb3-131" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb3-132"><a aria-hidden="true" href="#cb3-132" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb3-133"><a aria-hidden="true" href="#cb3-133" tabindex="-1"></a></span>
<span id="cb3-134"><a aria-hidden="true" href="#cb3-134" tabindex="-1"></a><span class=
"co">// withResumeFunc is a functional option for Semaphore to call when</span></span>
<span id="cb3-135"><a aria-hidden="true" href="#cb3-135" tabindex="-1"></a><span class=
"co">// resume from a pause happens.</span></span>
<span id="cb3-136"><a aria-hidden="true" href="#cb3-136" tabindex="-1"></a><span class=
"kw">func</span> WithResumeFunc<span class="op">(</span>fn <span class="kw">func</span><span class=
"op">())</span> <span class="kw">func</span><span class="op">(*</span>Semaphore<span class="op">)</span> <span class=
"op">{</span></span>
<span id="cb3-137"><a aria-hidden="true" href="#cb3-137" tabindex="-1"></a>    <span class=
"cf">return</span> <span class="kw">func</span><span class="op">(</span>sem <span class=
"op">*</span>Semaphore<span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-138"><a aria-hidden="true" href="#cb3-138" tabindex="-1"></a>        sem<span class=
"op">.</span>ResumeFunc <span class="op">=</span> fn</span>
<span id="cb3-139"><a aria-hidden="true" href="#cb3-139" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb3-140"><a aria-hidden="true" href="#cb3-140" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb3-141"><a aria-hidden="true" href="#cb3-141" tabindex="-1"></a></span>
<span id="cb3-142"><a aria-hidden="true" href="#cb3-142" tabindex="-1"></a><span class=
"co">// WithAquireBuffer is a functional option for Semaphore which</span></span>
<span id="cb3-143"><a aria-hidden="true" href="#cb3-143" tabindex="-1"></a><span class=
"co">// will set the throttle duration for attempting to re-aquire a spot.</span></span>
<span id="cb3-144"><a aria-hidden="true" href="#cb3-144" tabindex="-1"></a><span class=
"kw">func</span> WithAquireBuffer<span class="op">(</span>dur time<span class="op">.</span>Duration<span class=
"op">)</span> <span class="kw">func</span><span class="op">(*</span>Semaphore<span class="op">)</span> <span class=
"op">{</span></span>
<span id="cb3-145"><a aria-hidden="true" href="#cb3-145" tabindex="-1"></a>    <span class=
"cf">return</span> <span class="kw">func</span><span class="op">(</span>sem <span class=
"op">*</span>Semaphore<span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-146"><a aria-hidden="true" href="#cb3-146" tabindex="-1"></a>        sem<span class=
"op">.</span>AquireBuffer <span class="op">=</span> dur</span>
<span id="cb3-147"><a aria-hidden="true" href="#cb3-147" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb3-148"><a aria-hidden="true" href="#cb3-148" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb3-149"><a aria-hidden="true" href="#cb3-149" tabindex="-1"></a></span>
<span id="cb3-150"><a aria-hidden="true" href="#cb3-150" tabindex="-1"></a><span class=
"co">// WithPauseBuffer is a functional option for Semaphore which</span></span>
<span id="cb3-151"><a aria-hidden="true" href="#cb3-151" tabindex="-1"></a><span class=
"co">// will set an additional duration to append to the pause duration.</span></span>
<span id="cb3-152"><a aria-hidden="true" href="#cb3-152" tabindex="-1"></a><span class=
"kw">func</span> WithPauseBuffer<span class="op">(</span>dur time<span class="op">.</span>Duration<span class=
"op">)</span> <span class="kw">func</span><span class="op">(*</span>Semaphore<span class="op">)</span> <span class=
"op">{</span></span>
<span id="cb3-153"><a aria-hidden="true" href="#cb3-153" tabindex="-1"></a>    <span class=
"cf">return</span> <span class="kw">func</span><span class="op">(</span>sem <span class=
"op">*</span>Semaphore<span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-154"><a aria-hidden="true" href="#cb3-154" tabindex="-1"></a>        sem<span class=
"op">.</span>PauseBuffer <span class="op">=</span> dur</span>
<span id="cb3-155"><a aria-hidden="true" href="#cb3-155" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb3-156"><a aria-hidden="true" href="#cb3-156" tabindex="-1"></a><span class=
"op">}</span></span></code></pre>
              </div>

              <p>
                Example usage:
              </p>

              <div class="sourceCode" id="cb4">
                <pre class="sourceCode go"><code class="sourceCode go"><span id="cb4-1"><a aria-hidden="true" href=
                "#cb4-1" tabindex="-1"></a><span class="kw">package</span> main</span>
<span id="cb4-2"><a aria-hidden="true" href="#cb4-2" tabindex="-1"></a></span>
<span id="cb4-3"><a aria-hidden="true" href="#cb4-3" tabindex="-1"></a><span class="kw">import</span> <span class=
"op">(</span></span>
<span id="cb4-4"><a aria-hidden="true" href="#cb4-4" tabindex="-1"></a>  <span class="st">"log"</span></span>
<span id="cb4-5"><a aria-hidden="true" href="#cb4-5" tabindex="-1"></a>  ssem <span class=
"st">"github.com/gniktr/shopifysemaphore"</span></span>
<span id="cb4-6"><a aria-hidden="true" href="#cb4-6" tabindex="-1"></a><span class="op">)</span></span>
<span id="cb4-7"><a aria-hidden="true" href="#cb4-7" tabindex="-1"></a></span>
<span id="cb4-8"><a aria-hidden="true" href="#cb4-8" tabindex="-1"></a><span class="kw">func</span> work<span class=
"op">(</span>id <span class="dt">int</span><span class="op">,</span> wg <span class="op">*</span>sync<span class=
"op">.</span>WaitGroup<span class="op">,</span> ctx context<span class="op">.</span>Context<span class=
"op">,</span> sem <span class="op">*</span>ssem<span class="op">.</span>Semaphore<span class="op">)</span> <span class=
"op">{</span></span>
<span id="cb4-9"><a aria-hidden="true" href="#cb4-9" tabindex="-1"></a>  err <span class="op">:=</span> sem<span class=
"op">.</span>Aquire<span class="op">(</span>ctx<span class="op">)</span></span>
<span id="cb4-10"><a aria-hidden="true" href="#cb4-10" tabindex="-1"></a>  <span class="cf">if</span> err <span class=
"op">!=</span> <span class="ot">nil</span> <span class="op">{</span></span>
<span id="cb4-11"><a aria-hidden="true" href="#cb4-11" tabindex="-1"></a>    <span class=
"co">// Possible context timeout.</span></span>
<span id="cb4-12"><a aria-hidden="true" href="#cb4-12" tabindex="-1"></a>    log<span class=
"op">.</span>Printf<span class="op">(</span><span class="st">"work: %w</span><span class="ch">\n</span><span class=
"st">"</span><span class="op">,</span> err<span class="op">)</span></span>
<span id="cb4-13"><a aria-hidden="true" href="#cb4-13" tabindex="-1"></a>    wg<span class=
"op">.</span>Done<span class="op">()</span></span>
<span id="cb4-14"><a aria-hidden="true" href="#cb4-14" tabindex="-1"></a>    <span class="cf">return</span></span>
<span id="cb4-15"><a aria-hidden="true" href="#cb4-15" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb4-16"><a aria-hidden="true" href="#cb4-16" tabindex="-1"></a></span>
<span id="cb4-17"><a aria-hidden="true" href="#cb4-17" tabindex="-1"></a>  <span class=
"co">// Return remaining points from call.</span></span>
<span id="cb4-18"><a aria-hidden="true" href="#cb4-18" tabindex="-1"></a>  points<span class=
"op">,</span> err <span class="op">:=</span> graphQLCall<span class="op">()</span></span>
<span id="cb4-19"><a aria-hidden="true" href="#cb4-19" tabindex="-1"></a>  <span class="cf">if</span> err <span class=
"op">!=</span> <span class="ot">nil</span> <span class="op">{</span></span>
<span id="cb4-20"><a aria-hidden="true" href="#cb4-20" tabindex="-1"></a>    log<span class=
"op">.</span>Printf<span class="op">(</span><span class="st">"work: %w</span><span class="ch">\n</span><span class=
"st">"</span><span class="op">,</span> err<span class="op">)</span></span>
<span id="cb4-21"><a aria-hidden="true" href="#cb4-21" tabindex="-1"></a></span>
<span id="cb4-22"><a aria-hidden="true" href="#cb4-22" tabindex="-1"></a>    <span class=
"co">// If error is a network error or bad request for example, essentially</span></span>
<span id="cb4-23"><a aria-hidden="true" href="#cb4-23" tabindex="-1"></a>    <span class=
"co">// any error which would cause the response to *not* return point information,</span></span>
<span id="cb4-24"><a aria-hidden="true" href="#cb4-24" tabindex="-1"></a>    <span class=
"co">// then you should set the points to ErrPts to not trigger a point</span></span>
<span id="cb4-25"><a aria-hidden="true" href="#cb4-25" tabindex="-1"></a>    <span class=
"co">// update in Balance.</span></span>
<span id="cb4-26"><a aria-hidden="true" href="#cb4-26" tabindex="-1"></a>    points <span class=
"op">:=</span> ssem<span class="op">.</span>ErrPts</span>
<span id="cb4-27"><a aria-hidden="true" href="#cb4-27" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb4-28"><a aria-hidden="true" href="#cb4-28" tabindex="-1"></a>  log<span class=
"op">.</span>Printf<span class="op">(</span><span class="st">"remaining: %d points</span><span class=
"ch">\n</span><span class="st">"</span><span class="op">,</span> points<span class="op">)</span></span>
<span id="cb4-29"><a aria-hidden="true" href="#cb4-29" tabindex="-1"></a></span>
<span id="cb4-30"><a aria-hidden="true" href="#cb4-30" tabindex="-1"></a>  wg<span class="op">.</span>Done<span class=
"op">()</span></span>
<span id="cb4-31"><a aria-hidden="true" href="#cb4-31" tabindex="-1"></a>  sem<span class=
"op">.</span>Release<span class="op">(</span>points<span class="op">)</span></span>
<span id="cb4-32"><a aria-hidden="true" href="#cb4-32" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb4-33"><a aria-hidden="true" href="#cb4-33" tabindex="-1"></a></span>
<span id="cb4-34"><a aria-hidden="true" href="#cb4-34" tabindex="-1"></a><span class="kw">func</span> main<span class=
"op">()</span> <span class="op">{</span></span>
<span id="cb4-35"><a aria-hidden="true" href="#cb4-35" tabindex="-1"></a>  log<span class=
"op">.</span>Println<span class="op">(</span><span class="st">"started!"</span><span class="op">)</span></span>
<span id="cb4-36"><a aria-hidden="true" href="#cb4-36" tabindex="-1"></a>  done <span class="op">:=</span> <span class=
"bu">make</span><span class="op">(</span><span class="kw">chan</span> <span class="dt">bool</span><span class=
"op">)</span></span>
<span id="cb4-37"><a aria-hidden="true" href="#cb4-37" tabindex="-1"></a>  ctx<span class=
"op">,</span> cancel <span class="op">:=</span> context<span class="op">.</span>WithTimeout<span class=
"op">(</span>context<span class="op">.</span>Background<span class="op">(),</span> <span class=
"dv">5</span> <span class="op">*</span> time<span class="op">.</span>Minute<span class="op">)</span></span>
<span id="cb4-38"><a aria-hidden="true" href="#cb4-38" tabindex="-1"></a></span>
<span id="cb4-39"><a aria-hidden="true" href="#cb4-39" tabindex="-1"></a>  <span class=
"co">// Semaphore with a concurrent capacity of 10.</span></span>
<span id="cb4-40"><a aria-hidden="true" href="#cb4-40" tabindex="-1"></a>  <span class=
"co">// Including a point balance setup with a threshold to pause at 200 points,</span></span>
<span id="cb4-41"><a aria-hidden="true" href="#cb4-41" tabindex="-1"></a>  <span class=
"co">// a maximum of 2000 points available, and a refill rate of 100 points per second.</span></span>
<span id="cb4-42"><a aria-hidden="true" href="#cb4-42" tabindex="-1"></a>  sem <span class=
"op">:=</span> ssem<span class="op">.</span>NewSemaphore<span class="op">(</span></span>
<span id="cb4-43"><a aria-hidden="true" href="#cb4-43" tabindex="-1"></a>    <span class="dv">10</span><span class=
"op">,</span></span>
<span id="cb4-44"><a aria-hidden="true" href="#cb4-44" tabindex="-1"></a>    ssem<span class=
"op">.</span>NewBalance<span class="op">(</span><span class="dv">200</span><span class="op">,</span> <span class=
"dv">2000</span><span class="op">,</span> <span class="dv">100</span><span class="op">),</span></span>
<span id="cb4-45"><a aria-hidden="true" href="#cb4-45" tabindex="-1"></a>    ssem<span class=
"op">.</span>WithPauseFunc<span class="op">(</span><span class="kw">func</span> <span class=
"op">(</span>pts <span class="dt">int32</span><span class="op">,</span> dur time<span class=
"op">.</span>Duration<span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-46"><a aria-hidden="true" href="#cb4-46" tabindex="-1"></a>      log<span class=
"op">.</span>Printf<span class="op">(</span><span class=
"st">"pausing for %s due to remaining points of %d...</span><span class="ch">\n</span><span class=
"st">"</span><span class="op">,</span> dur<span class="op">,</span> pts<span class="op">)</span></span>
<span id="cb4-47"><a aria-hidden="true" href="#cb4-47" tabindex="-1"></a>    <span class="op">}),</span></span>
<span id="cb4-48"><a aria-hidden="true" href="#cb4-48" tabindex="-1"></a>    ssem<span class=
"op">.</span>WithResumeFunc<span class="op">(</span><span class="kw">func</span> <span class=
"op">()</span> <span class="op">{</span></span>
<span id="cb4-49"><a aria-hidden="true" href="#cb4-49" tabindex="-1"></a>      log<span class=
"op">.</span>Println<span class="op">(</span><span class="st">"resuming..."</span><span class="op">)</span></span>
<span id="cb4-50"><a aria-hidden="true" href="#cb4-50" tabindex="-1"></a>    <span class="op">})</span></span>
<span id="cb4-51"><a aria-hidden="true" href="#cb4-51" tabindex="-1"></a>  <span class="op">)</span></span>
<span id="cb4-52"><a aria-hidden="true" href="#cb4-52" tabindex="-1"></a></span>
<span id="cb4-53"><a aria-hidden="true" href="#cb4-53" tabindex="-1"></a>  <span class=
"co">// Run 100 Goroutines.</span></span>
<span id="cb4-54"><a aria-hidden="true" href="#cb4-54" tabindex="-1"></a>  <span class=
"kw">var</span> wg sync<span class="op">.</span>WaitGroup</span>
<span id="cb4-55"><a aria-hidden="true" href="#cb4-55" tabindex="-1"></a>  <span class="cf">for</span> i <span class=
"op">:=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class=
"dv">100</span><span class="op">;</span> i <span class="op">+=</span> <span class="dv">1</span> <span class=
"op">{</span></span>
<span id="cb4-56"><a aria-hidden="true" href="#cb4-56" tabindex="-1"></a>    wg<span class="op">.</span>Add<span class=
"op">(</span><span class="dv">1</span><span class="op">)</span></span>
<span id="cb4-57"><a aria-hidden="true" href="#cb4-57" tabindex="-1"></a>    <span class=
"cf">go</span> work<span class="op">(</span>i<span class="op">,</span> <span class="op">&</span>wg<span class=
"op">,</span> ctx<span class="op">,</span> sem<span class="op">)</span></span>
<span id="cb4-58"><a aria-hidden="true" href="#cb4-58" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb4-59"><a aria-hidden="true" href="#cb4-59" tabindex="-1"></a></span>
<span id="cb4-60"><a aria-hidden="true" href="#cb4-60" tabindex="-1"></a>  <span class=
"co">// Wait for completion of Goroutines.</span></span>
<span id="cb4-61"><a aria-hidden="true" href="#cb4-61" tabindex="-1"></a>  <span class="cf">go</span> <span class=
"kw">func</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb4-62"><a aria-hidden="true" href="#cb4-62" tabindex="-1"></a>    wg<span class=
"op">.</span>Wait<span class="op">()</span></span>
<span id="cb4-63"><a aria-hidden="true" href="#cb4-63" tabindex="-1"></a>    done <span class=
"op">&lt;-</span> <span class="ot">true</span></span>
<span id="cb4-64"><a aria-hidden="true" href="#cb4-64" tabindex="-1"></a>  <span class="op">}()</span></span>
<span id="cb4-65"><a aria-hidden="true" href="#cb4-65" tabindex="-1"></a></span>
<span id="cb4-66"><a aria-hidden="true" href="#cb4-66" tabindex="-1"></a>  <span class="cf">select</span> <span class=
"op">{</span></span>
<span id="cb4-67"><a aria-hidden="true" href="#cb4-67" tabindex="-1"></a>    <span class="cf">case</span> <span class=
"op">&lt;-</span>ctx<span class="op">.</span>Done<span class="op">():</span></span>
<span id="cb4-68"><a aria-hidden="true" href="#cb4-68" tabindex="-1"></a>      log<span class=
"op">.</span>Println<span class="op">(</span><span class="st">"timeout happened."</span><span class=
"op">)</span></span>
<span id="cb4-69"><a aria-hidden="true" href="#cb4-69" tabindex="-1"></a>    <span class="cf">case</span> <span class=
"op">&lt;-</span>done<span class="op">:</span></span>
<span id="cb4-70"><a aria-hidden="true" href="#cb4-70" tabindex="-1"></a>      log<span class=
"op">.</span>Println<span class="op">(</span><span class="st">"work finished."</span><span class="op">)</span></span>
<span id="cb4-71"><a aria-hidden="true" href="#cb4-71" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb4-72"><a aria-hidden="true" href="#cb4-72" tabindex="-1"></a>  log<span class=
"op">.</span>Println<span class="op">(</span><span class="st">"completed."</span><span class="op">)</span></span>
<span id="cb4-73"><a aria-hidden="true" href="#cb4-73" tabindex="-1"></a><span class="op">}</span></span></code></pre>
              </div>

              <p>
                Example output:
              </p>

              <pre><code>started!
remaining: 1840 points
remaining: 1710 points
remaining: 1660 points
...
remaining: 280 points
remaining: 190 points
pausing for 18 seconds due to remaining points of 190...
resuming...
remaining: 1890 points
remaining: 1810 points
...
work finished.
completed.</code></pre>
              <p>
                Using the example semaphore method above, we are allowing 10 Goroutines to run concurrently out of the
                1000 and upon each Goroutine’s completion, the Goroutine will report the remaining points back to the
                release mechanism, which will determine if a pause is needed before actually issuing the release.
              </p>

              <p>
                In the context of the integration application project, it was a success! The previously mentioned
                3,000-3,500 inventory updates were able to process within 3.5-4.5 minutes without hitting the threshold
                often.
              </p>

              <p>
                Hopefully this helpful to those looking to do similar. I have released this method as a Go package,
                which you can find <a href="https://github.com/gnikyt/shopifysemaphore">here on Github</a>.
              </p>
            </div>
          </div>
        </div>
      </article>

      <section class="tab tab--appendix">
        <div class="tab__title tab__title--short">
          Appendix
        </div>

        <div class="tab__container">
          <div class="tab__content">
            <div class="content-container">
              <p>
                Copyright under <a class="sources__link" href="https://creativecommons.org/licenses/by/4.0/" rel=
                "noopener" target="_blank">CC-4.0</a>.
              </p>

              <p>
                Available in the following alternative formats: <span class="sources"><a class="sources__link" href=
                "/handling-shopify-api-limits-goroutines/index.md">MD</a>&nbsp;&nbsp;/&nbsp;&nbsp;<a class=
                "sources__link" href=
                "/handling-shopify-api-limits-goroutines/index.txt">TXT</a>&nbsp;&nbsp;/&nbsp;&nbsp;<a href="" onclick=
                "window.print(); return false;">PDF</a></span>
              </p>
            </div>
          </div>
        </div>
      </section>
    </main>

    <footer class="site-tail container">
      <div class="site-tail__avatar">
        <a href="/about"><img alt="Ty King" class="site-tail__avatar-img" src="/assets/images/me.jpg"></a>
      </div>

      <div class="site-tail__about">
        <h3 class="site-tail__author">
          <a href="/about">Ty King</a>
        </h3>

        <p class="site-tail__blurb">
          A self-taught, seasoned, and versatile developer from Newfoundland. <span>Crafting innovative solutions with
          care and expertise.</span>
        </p>
      </div>

      <div class="site-tail__blurb-ext">
        <p class="site-tail__blurb">
          Crafting innovative solutions with care and expertise.
        </p>
      </div>

      <div class="site-tail__links">
        <a class="button button--strong" href="https://github.com/gnikyt" rel="noopener" target=
        "_blank">Github</a><a class="button button--strong" href="https://linkedin.com/in/gnikyt" rel="noopener"
        target="_blank">LinkedIn</a><a class="button button--strong" href="/assets/files/cv.pdf" target=
        "_blank">CV</a><a class="button button--strong" href="/rss.xml" target="_blank">RSS</a>
      </div>
    </footer>

    <ul class="site-colors container container--short">
      <li class="site-colors__color color--a">
      </li>

      <li class="site-colors__color color--b">
      </li>

      <li class="site-colors__color color--c">
      </li>

      <li class="site-colors__color color--d">
      </li>

      <li class="site-colors__color color--e">
      </li>

      <li class="site-colors__color color--f">
      </li>

      <li class="site-colors__color color--g">
      </li>

      <li class="site-colors__color color--h">
      </li>
    </ul>
  </body>
</html>
