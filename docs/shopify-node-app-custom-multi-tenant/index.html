<!--
  Hello! Lookin' for something? Well... it was built quickly, hope thats OK with you!
  https://github.com/gnikyt/gnikyt.github.io
-->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1" name="viewport">
    <title>
      Shopify Node App custom multi-tenant support | gnikyt
    </title>
    <link href="https://gnikyt.com/shopify-node-app-custom-multi-tenant" rel="canonical">
    <meta content="Custom" name="generator">
    <meta content=
    "## Introduction Shopify's new boilerplate for app development with Node works well. It gets a lot of small details out of the way, allo..."
    name="description">
    <meta content="2021-11-15T16:35:00-0330" property="article:published_time">
    <meta content="Shopify Node App custom multi-tenant support" property="og:title">
    <meta content="en" property="og:locale">
    <meta content=
    "## Introduction Shopify's new boilerplate for app development with Node works well. It gets a lot of small details out of the way, allo..."
    property="og:description">
    <meta content="https://gnikyt.com/shopify-node-app-custom-multi-tenant" property="og:url">
    <meta content="gnikyt" property="og:site_name">
    <meta content="article" property="og:type">
    <meta content="summary" name="twitter:card">
    <meta content=
    "## Introduction Shopify's new boilerplate for app development with Node works well. It gets a lot of small details out of the way, allo..."
    property="twitter:title">
    <script type="application/ld+json">
    {
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "dateModified": "2021-11-15T16:35:00-0330",
    "datePublished": "2021-11-15T16:35:00-0330",
    "description": "
    ## Introduction

    Shopify's new boilerplate for app development with Node works well. It gets a lot of small details out of the way, allo...",
    "headline": "Shopify Node App custom multi-tenant support",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "https://gnikyt.com/shopify-node-app-custom-multi-tenant"
    },
    "publisher": {
      "@type": "Organization",
      "logo": {
        "@type": "ImageObject",
        "url": "https://gnikyt.com/assets/favicon-32x32.png"
      }
    },
    "url": "https://gnikyt.com/shopify-node-app-custom-multi-tenant"
    }
    </script>
    <link as="font" crossorigin="anonymous" href="/assets/fonts/RobotoMono-Regular.woff2" rel="preload" type=
    "font/woff2">
    <link as="font" crossorigin="anonymous" href="/assets/fonts/RobotoMono-Bold.woff2" rel="preload" type="font/woff2">
    <link as="font" crossorigin="anonymous" href="/assets/fonts/RobotoMono-Light.woff2" rel="preload" type=
    "font/woff2">
    <link href="/assets/images/favicon.ico" rel="shortcut icon" type="image/x-icon">
    <link href="/assets/images/favicon.png" rel="icon" sizes="32x32" type="image/png">
    <link href="/rss.xml" rel="alternate" title="gnikyt feed" type="application/rss+xml">
    <link href="/assets/styles/style.css" rel="stylesheet">
    <link href="/assets/styles/highlight.css" rel="stylesheet">
  </head>
  <body class="layout layout--post" data-handle="shopify-node-app-custom-multi-tenant">
    <header class="site-head container">
      <span class="site-head__item"><a class="site-head__link" href="/">gnikyt</a></span> <span class=
      "site-head__item site-head__item--tag"><span>&nbsp;&nbsp;</span>/&nbsp;&nbsp;Code ramblings</span>
    </header>

    <main class="container">
      <article class="tab post">
        <header class="post__head">
          <h1 class="tab__title tab__title--short post__title">
            Shopify Node App custom multi-tenant support /
          </h1>
        </header>

        <div class="tab__container">
          <div class="tab__content">
            <div class="post__meta content-container">
              <div class="post__details">
                /* <time class="post__time" datetime="2021-11-15">Nov 15,
                2021</time>&nbsp;&nbsp;—&nbsp;&nbsp;<span class="post__size">10KB</span> */
              </div>

              <div class="post__category">
                <a href="/category/shopify"><img alt="Logo of shopify" class="post__category-logo" src=
                "/assets/images/category-shopify.svg"></a><a href="/category/javascript"><img alt="Logo of javascript"
                class="post__category-logo" src="/assets/images/category-javascript.svg"></a>
              </div>
            </div>

            <div class="content-container">
              <h2 id="introduction">
                Introduction
              </h2>

              <p>
                Shopify’s new boilerplate for app development with Node works well. It gets a lot of small details out
                of the way, allowing you to code an app with built in Polaris support, verification, and more.
              </p>

              <p>
                However, Shopify no longer allows you to develop an unpublished app and have it installable by multiple
                shops, this was allowed years ago, but they have phased this out. There are now two options for
                developing apps.
              </p>

              <ul>
                <li>
                  <code>Custom</code> - Allows you to develop an app for a single shop which does not have to be
                  published or reviewed by Shopify
                </li>

                <li>
                  <code>Public</code> - Allows you to develop an app for use for the general public, reviewed by
                  Shopify
                </li>
              </ul>

              <p>
                The problem is, there are instances where you will may need to develop a <code>Custom</code> type app
                for a client who owns multiple shops, clients who wish to keep the app private but utilize the same app
                for all their shops.
              </p>

              <p>
                By default, the <code>Custom</code> app route along with the Node boilerplate, will not support this.
                Below is a quick solution I have used to get around this limitation.
              </p>

              <h2 id="backend-changes">
                Backend Changes
              </h2>

              <h3 id="env">
                ENV
              </h3>

              <p>
                In your env file, you will create an API key and secret entry per shop, that has no special characters.
              </p>

              <p>
                If the shops are <code>hello-world.myshopify.com</code> and <code>welcome-123.myshopify.com</code>, you
                would add:
              </p>

              <pre class="conf"><code>SHOPIFY_API_KEY_HELLOWORLD=xyz123
SHOPIFY_API_SECRET_HELLOWORLD=123xyz
SHOPIFY_API_KEY_WELCOME123=abc123
SHOPIFY_API_SECRET_WELCOME123=123abc</code></pre>
              <h3 id="nextjs">
                NextJS
              </h3>

              <p>
                Open <code>next.config.js</code>.
              </p>

              <p>
                By default, it looks like this:
              </p>

              <div class="sourceCode" id="cb2">
                <pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb2-1"><a aria-hidden=
                "true" href="#cb2-1" tabindex="-1"></a><span class="kw">const</span> { <span class=
                "dt">parsed</span><span class="op">:</span> localEnv } <span class="op">=</span> <span class=
                "pp">require</span>(<span class="st">"dotenv"</span>)<span class="op">.</span><span class=
                "fu">config</span>()<span class="op">;</span></span>
<span id="cb2-2"><a aria-hidden="true" href="#cb2-2" tabindex="-1"></a><span class=
"kw">const</span> webpack <span class="op">=</span> <span class="pp">require</span>(<span class=
"st">"webpack"</span>)<span class="op">;</span></span>
<span id="cb2-3"><a aria-hidden="true" href="#cb2-3" tabindex="-1"></a><span class=
"kw">const</span> apiKey <span class="op">=</span> <span class="bu">JSON</span><span class="op">.</span><span class=
"fu">stringify</span>(<span class="bu">process</span><span class="op">.</span><span class="at">env</span><span class=
"op">.</span><span class="at">SHOPIFY_API_KEY</span>)<span class="op">;</span></span>
<span id="cb2-4"><a aria-hidden="true" href="#cb2-4" tabindex="-1"></a></span>
<span id="cb2-5"><a aria-hidden="true" href="#cb2-5" tabindex="-1"></a>module<span class="op">.</span><span class=
"at">exports</span> <span class="op">=</span> {</span>
<span id="cb2-6"><a aria-hidden="true" href="#cb2-6" tabindex="-1"></a>  <span class="dt">webpack</span><span class=
"op">:</span> (config) <span class="kw">=&gt;</span> {</span>
<span id="cb2-7"><a aria-hidden="true" href="#cb2-7" tabindex="-1"></a>    <span class=
"kw">const</span> env <span class="op">=</span> { <span class="dt">API_KEY</span><span class=
"op">:</span> apiKey }<span class="op">;</span></span>
<span id="cb2-8"><a aria-hidden="true" href="#cb2-8" tabindex="-1"></a>    config<span class="op">.</span><span class=
"at">plugins</span><span class="op">.</span><span class="fu">push</span>(<span class=
"kw">new</span> webpack<span class="op">.</span><span class="fu">DefinePlugin</span>(env))<span class=
"op">;</span></span>
<span id="cb2-9"><a aria-hidden="true" href="#cb2-9" tabindex="-1"></a></span>
<span id="cb2-10"><a aria-hidden="true" href="#cb2-10" tabindex="-1"></a>    <span class=
"co">// Add ESM support for .mjs files in webpack 4</span></span>
<span id="cb2-11"><a aria-hidden="true" href="#cb2-11" tabindex="-1"></a>    config<span class=
"op">.</span><span class="at">module</span><span class="op">.</span><span class="at">rules</span><span class=
"op">.</span><span class="fu">push</span>({</span>
<span id="cb2-12"><a aria-hidden="true" href="#cb2-12" tabindex="-1"></a>      <span class="dt">test</span><span class=
"op">:</span> <span class="ss">/</span><span class="sc">\.</span><span class="ss">mjs</span><span class=
"sc">$</span><span class="ss">/</span><span class="op">,</span></span>
<span id="cb2-13"><a aria-hidden="true" href="#cb2-13" tabindex="-1"></a>      <span class=
"dt">include</span><span class="op">:</span> <span class="ss">/node_modules/</span><span class="op">,</span></span>
<span id="cb2-14"><a aria-hidden="true" href="#cb2-14" tabindex="-1"></a>      <span class="dt">type</span><span class=
"op">:</span> <span class="st">"javascript/auto"</span><span class="op">,</span></span>
<span id="cb2-15"><a aria-hidden="true" href="#cb2-15" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb2-16"><a aria-hidden="true" href="#cb2-16" tabindex="-1"></a></span>
<span id="cb2-17"><a aria-hidden="true" href="#cb2-17" tabindex="-1"></a>    <span class=
"cf">return</span> config<span class="op">;</span></span>
<span id="cb2-18"><a aria-hidden="true" href="#cb2-18" tabindex="-1"></a>  }<span class="op">,</span></span>
<span id="cb2-19"><a aria-hidden="true" href="#cb2-19" tabindex="-1"></a>}<span class="op">;</span></span></code></pre>
              </div>

              <p>
                We need to remove <code>API_KEY</code> and add a new <code>HOST</code> value.
              </p>

              <div class="sourceCode" id="cb3">
                <pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb3-1"><a aria-hidden=
                "true" href="#cb3-1" tabindex="-1"></a># <span class="op">./</span>next<span class=
                "op">.</span><span class="at">config</span><span class="op">.</span><span class="at">js</span></span>
<span id="cb3-2"><a aria-hidden="true" href="#cb3-2" tabindex="-1"></a><span class="kw">const</span> { <span class=
"dt">parsed</span><span class="op">:</span> localEnv } <span class="op">=</span> <span class=
"pp">require</span>(<span class="st">"dotenv"</span>)<span class="op">.</span><span class=
"fu">config</span>()<span class="op">;</span></span>
<span id="cb3-3"><a aria-hidden="true" href="#cb3-3" tabindex="-1"></a><span class=
"kw">const</span> webpack <span class="op">=</span> <span class="pp">require</span>(<span class=
"st">"webpack"</span>)<span class="op">;</span></span>
<span id="cb3-4"><a aria-hidden="true" href="#cb3-4" tabindex="-1"></a><span class="kw">const</span> host <span class=
"op">=</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(<span class=
"bu">process</span><span class="op">.</span><span class="at">env</span><span class="op">.</span><span class=
"at">HOST</span>)<span class="op">;</span></span>
<span id="cb3-5"><a aria-hidden="true" href="#cb3-5" tabindex="-1"></a></span>
<span id="cb3-6"><a aria-hidden="true" href="#cb3-6" tabindex="-1"></a>module<span class="op">.</span><span class=
"at">exports</span> <span class="op">=</span> {</span>
<span id="cb3-7"><a aria-hidden="true" href="#cb3-7" tabindex="-1"></a>  <span class="dt">webpack</span><span class=
"op">:</span> (config) <span class="kw">=&gt;</span> {</span>
<span id="cb3-8"><a aria-hidden="true" href="#cb3-8" tabindex="-1"></a>    <span class=
"kw">const</span> env <span class="op">=</span> { <span class="dt">HOST</span><span class=
"op">:</span> host }<span class="op">;</span></span>
<span id="cb3-9"><a aria-hidden="true" href="#cb3-9" tabindex="-1"></a>    config<span class="op">.</span><span class=
"at">plugins</span><span class="op">.</span><span class="fu">push</span>(<span class=
"kw">new</span> webpack<span class="op">.</span><span class="fu">DefinePlugin</span>(env))<span class=
"op">;</span></span>
<span id="cb3-10"><a aria-hidden="true" href="#cb3-10" tabindex="-1"></a></span>
<span id="cb3-11"><a aria-hidden="true" href="#cb3-11" tabindex="-1"></a>    <span class=
"co">// Add ESM support for .mjs files in webpack 4</span></span>
<span id="cb3-12"><a aria-hidden="true" href="#cb3-12" tabindex="-1"></a>    config<span class=
"op">.</span><span class="at">module</span><span class="op">.</span><span class="at">rules</span><span class=
"op">.</span><span class="fu">push</span>({</span>
<span id="cb3-13"><a aria-hidden="true" href="#cb3-13" tabindex="-1"></a>      <span class="dt">test</span><span class=
"op">:</span> <span class="ss">/</span><span class="sc">\.</span><span class="ss">mjs</span><span class=
"sc">$</span><span class="ss">/</span><span class="op">,</span></span>
<span id="cb3-14"><a aria-hidden="true" href="#cb3-14" tabindex="-1"></a>      <span class=
"dt">include</span><span class="op">:</span> <span class="ss">/node_modules/</span><span class="op">,</span></span>
<span id="cb3-15"><a aria-hidden="true" href="#cb3-15" tabindex="-1"></a>      <span class="dt">type</span><span class=
"op">:</span> <span class="st">"javascript/auto"</span><span class="op">,</span></span>
<span id="cb3-16"><a aria-hidden="true" href="#cb3-16" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb3-17"><a aria-hidden="true" href="#cb3-17" tabindex="-1"></a></span>
<span id="cb3-18"><a aria-hidden="true" href="#cb3-18" tabindex="-1"></a>    <span class=
"cf">return</span> config<span class="op">;</span></span>
<span id="cb3-19"><a aria-hidden="true" href="#cb3-19" tabindex="-1"></a>  }<span class="op">,</span></span>
<span id="cb3-20"><a aria-hidden="true" href="#cb3-20" tabindex="-1"></a>}<span class="op">;</span></span></code></pre>
              </div>

              <h3 id="utils">
                Utils
              </h3>

              <p>
                Create a file to hold some utility functions which we will use to support multi-tentant.
              </p>

              <div class="sourceCode" id="cb4">
                <pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb4-1"><a aria-hidden=
                "true" href="#cb4-1" tabindex="-1"></a># <span class="op">./</span>src<span class=
                "op">/</span>services<span class="op">/</span>utils<span class="op">.</span><span class=
                "at">js</span></span>
<span id="cb4-2"><a aria-hidden="true" href="#cb4-2" tabindex="-1"></a><span class=
"im">import</span> crypto <span class="im">from</span> <span class="st">"crypto"</span><span class="op">;</span></span>
<span id="cb4-3"><a aria-hidden="true" href="#cb4-3" tabindex="-1"></a><span class=
"im">import</span> querystring <span class="im">from</span> <span class="st">"querystring"</span><span class=
"op">;</span> <span class="co">// Can use URLSearchParams instead</span></span>
<span id="cb4-4"><a aria-hidden="true" href="#cb4-4" tabindex="-1"></a></span>
<span id="cb4-5"><a aria-hidden="true" href="#cb4-5" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb4-6"><a aria-hidden="true" href="#cb4-6" tabindex="-1"></a><span class=
"co"> * Clean the domain. Used for ENV access.</span></span>
<span id="cb4-7"><a aria-hidden="true" href="#cb4-7" tabindex="-1"></a><span class="co"> * </span><span class=
"an">@param</span><span class="co"> </span><span class="cv">{string}</span><span class=
"co"> domain The Shopify myshopify.com domain.</span></span>
<span id="cb4-8"><a aria-hidden="true" href="#cb4-8" tabindex="-1"></a><span class="co"> * </span><span class=
"an">@param</span><span class="co"> </span><span class="cv">{boolean}</span><span class=
"co"> upcase Upcase the result or not.</span></span>
<span id="cb4-9"><a aria-hidden="true" href="#cb4-9" tabindex="-1"></a><span class="co"> * </span><span class=
"an">@returns</span><span class="co"> string</span></span>
<span id="cb4-10"><a aria-hidden="true" href="#cb4-10" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb4-11"><a aria-hidden="true" href="#cb4-11" tabindex="-1"></a><span class=
"kw">const</span> cleanDomain <span class="op">=</span> (domain<span class="op">,</span> upcase <span class=
"op">=</span> <span class="kw">true</span>) <span class="kw">=&gt;</span> {</span>
<span id="cb4-12"><a aria-hidden="true" href="#cb4-12" tabindex="-1"></a>  <span class=
"kw">const</span> result <span class="op">=</span> domain<span class="op">.</span><span class=
"fu">replace</span>(<span class="st">".myshopify.com"</span><span class="op">,</span> <span class=
"st">""</span>)<span class="op">.</span><span class="fu">replace</span>(<span class="ss">/_</span><span class=
"sc">|</span><span class="ss">-/g</span><span class="op">,</span> <span class="st">""</span>)<span class=
"op">;</span></span>
<span id="cb4-13"><a aria-hidden="true" href="#cb4-13" tabindex="-1"></a>  <span class=
"cf">return</span> upcase <span class="op">?</span> result<span class="op">.</span><span class=
"fu">toUpperCase</span>() <span class="op">:</span> result<span class="op">;</span></span>
<span id="cb4-14"><a aria-hidden="true" href="#cb4-14" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb4-15"><a aria-hidden="true" href="#cb4-15" tabindex="-1"></a></span>
<span id="cb4-16"><a aria-hidden="true" href="#cb4-16" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb4-17"><a aria-hidden="true" href="#cb4-17" tabindex="-1"></a><span class=
"co"> * Fix and order query strings.</span></span>
<span id="cb4-18"><a aria-hidden="true" href="#cb4-18" tabindex="-1"></a><span class=
"co"> * https://github.com/Shopify/shopify-node-api/blob/main/src/utils/hmac-validator.ts</span></span>
<span id="cb4-19"><a aria-hidden="true" href="#cb4-19" tabindex="-1"></a><span class="co"> * </span><span class=
"an">@param</span><span class="co"> </span><span class="cv">{object}</span><span class=
"co"> query The query params.</span></span>
<span id="cb4-20"><a aria-hidden="true" href="#cb4-20" tabindex="-1"></a><span class="co"> * </span><span class=
"an">@returns</span><span class="co"> string</span></span>
<span id="cb4-21"><a aria-hidden="true" href="#cb4-21" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb4-22"><a aria-hidden="true" href="#cb4-22" tabindex="-1"></a><span class="im">export</span> <span class=
"kw">function</span> <span class="fu">stringifyQuery</span>(query) {</span>
<span id="cb4-23"><a aria-hidden="true" href="#cb4-23" tabindex="-1"></a>  <span class=
"kw">const</span> orderedObj <span class="op">=</span> <span class="bu">Object</span><span class=
"op">.</span><span class="fu">keys</span>(query)</span>
<span id="cb4-24"><a aria-hidden="true" href="#cb4-24" tabindex="-1"></a>    <span class="op">.</span><span class=
"fu">sort</span>((val1<span class="op">,</span> val2) <span class="kw">=&gt;</span> val1<span class=
"op">.</span><span class="fu">localeCompare</span>(val2))</span>
<span id="cb4-25"><a aria-hidden="true" href="#cb4-25" tabindex="-1"></a>    <span class="op">.</span><span class=
"fu">reduce</span>((obj<span class="op">,</span> key) <span class="kw">=&gt;</span> {</span>
<span id="cb4-26"><a aria-hidden="true" href="#cb4-26" tabindex="-1"></a>      obj[key] <span class=
"op">=</span> query[key]<span class="op">;</span></span>
<span id="cb4-27"><a aria-hidden="true" href="#cb4-27" tabindex="-1"></a>      <span class=
"cf">return</span> obj<span class="op">;</span></span>
<span id="cb4-28"><a aria-hidden="true" href="#cb4-28" tabindex="-1"></a>    }<span class="op">,</span> {})<span class=
"op">;</span></span>
<span id="cb4-29"><a aria-hidden="true" href="#cb4-29" tabindex="-1"></a>  <span class=
"cf">return</span> querystring<span class="op">.</span><span class="fu">stringify</span>(orderedObj)<span class=
"op">;</span></span>
<span id="cb4-30"><a aria-hidden="true" href="#cb4-30" tabindex="-1"></a>}</span>
<span id="cb4-31"><a aria-hidden="true" href="#cb4-31" tabindex="-1"></a></span>
<span id="cb4-32"><a aria-hidden="true" href="#cb4-32" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb4-33"><a aria-hidden="true" href="#cb4-33" tabindex="-1"></a><span class=
"co"> * Create a local HMAC string based upon query params.</span></span>
<span id="cb4-34"><a aria-hidden="true" href="#cb4-34" tabindex="-1"></a><span class=
"co"> * https://github.com/Shopify/shopify-node-api/blob/main/src/utils/hmac-validator.ts</span></span>
<span id="cb4-35"><a aria-hidden="true" href="#cb4-35" tabindex="-1"></a><span class="co"> * </span><span class=
"an">@param</span><span class="co"> </span><span class="cv">{object}</span><span class=
"co"> query The query params.</span></span>
<span id="cb4-36"><a aria-hidden="true" href="#cb4-36" tabindex="-1"></a><span class="co"> * </span><span class=
"an">@param</span><span class="co"> </span><span class="cv">{strin}</span><span class=
"co"> secret The API secret.</span></span>
<span id="cb4-37"><a aria-hidden="true" href="#cb4-37" tabindex="-1"></a><span class="co"> * </span><span class=
"an">@returns</span><span class="co"> string</span></span>
<span id="cb4-38"><a aria-hidden="true" href="#cb4-38" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb4-39"><a aria-hidden="true" href="#cb4-39" tabindex="-1"></a><span class="im">export</span> <span class=
"kw">function</span> <span class="fu">generateLocalHmac</span>(query<span class="op">,</span> secret) {</span>
<span id="cb4-40"><a aria-hidden="true" href="#cb4-40" tabindex="-1"></a>  <span class=
"kw">const</span> queryString <span class="op">=</span> <span class="fu">stringifyQuery</span>(query)<span class=
"op">;</span></span>
<span id="cb4-41"><a aria-hidden="true" href="#cb4-41" tabindex="-1"></a>  <span class=
"cf">return</span> crypto<span class="op">.</span><span class="fu">createHmac</span>(<span class=
"st">"sha256"</span><span class="op">,</span> secret)<span class="op">.</span><span class=
"fu">update</span>(queryString)<span class="op">.</span><span class="fu">digest</span>(<span class=
"st">"hex"</span>)<span class="op">;</span></span>
<span id="cb4-42"><a aria-hidden="true" href="#cb4-42" tabindex="-1"></a>}</span></code></pre>
              </div>

              <h3 id="middleware-additions">
                Middleware Additions
              </h3>

              <h4 id="shopcontext">
                ShopContext
              </h4>

              <p>
                This middleware file for Koa will create the Shopify context.
              </p>

              <div class="sourceCode" id="cb5">
                <pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb5-1"><a aria-hidden=
                "true" href="#cb5-1" tabindex="-1"></a># <span class="op">./</span>src<span class=
                "op">/</span>server<span class="op">/</span>middleware<span class="op">/</span>shopContext<span class=
                "op">.</span><span class="at">js</span></span>
<span id="cb5-2"><a aria-hidden="true" href="#cb5-2" tabindex="-1"></a><span class=
"im">import</span> Shopify<span class="op">,</span> { ApiVersion } <span class="im">from</span> <span class=
"st">"@shopify/shopify-api"</span><span class="op">;</span></span>
<span id="cb5-3"><a aria-hidden="true" href="#cb5-3" tabindex="-1"></a><span class=
"im">import</span> { cleanDomain } <span class="im">from</span> <span class=
"st">"../../services/utils"</span><span class="op">;</span></span>
<span id="cb5-4"><a aria-hidden="true" href="#cb5-4" tabindex="-1"></a></span>
<span id="cb5-5"><a aria-hidden="true" href="#cb5-5" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb5-6"><a aria-hidden="true" href="#cb5-6" tabindex="-1"></a><span class=
"co"> * Set the Shopify context based upon the shop.</span></span>
<span id="cb5-7"><a aria-hidden="true" href="#cb5-7" tabindex="-1"></a><span class="co"> * </span><span class=
"an">@param</span><span class="co"> </span><span class="cv">{*}</span><span class=
"co"> ctx The Koa context.</span></span>
<span id="cb5-8"><a aria-hidden="true" href="#cb5-8" tabindex="-1"></a><span class="co"> * </span><span class=
"an">@param</span><span class="co"> </span><span class="cv">{*}</span><span class=
"co"> next The next code to hit.</span></span>
<span id="cb5-9"><a aria-hidden="true" href="#cb5-9" tabindex="-1"></a><span class="co"> * </span><span class=
"an">@returns</span><span class="co"> any</span></span>
<span id="cb5-10"><a aria-hidden="true" href="#cb5-10" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb5-11"><a aria-hidden="true" href="#cb5-11" tabindex="-1"></a><span class=
"kw">const</span> shopContext <span class="op">=</span> <span class="kw">async</span> (ctx<span class=
"op">,</span> next) <span class="kw">=&gt;</span> {</span>
<span id="cb5-12"><a aria-hidden="true" href="#cb5-12" tabindex="-1"></a>  <span class=
"co">// Find the Shopify domain</span></span>
<span id="cb5-13"><a aria-hidden="true" href="#cb5-13" tabindex="-1"></a>  <span class=
"kw">const</span> { shop } <span class="op">=</span> ctx<span class="op">.</span><span class=
"at">query</span><span class="op">;</span></span>
<span id="cb5-14"><a aria-hidden="true" href="#cb5-14" tabindex="-1"></a>  <span class=
"kw">const</span> shopDomain <span class="op">=</span> ctx<span class="op">.</span><span class=
"at">request</span><span class="op">.</span><span class="at">headers</span>[<span class=
"st">"x-shopify-shop-domain"</span>]<span class="op">;</span></span>
<span id="cb5-15"><a aria-hidden="true" href="#cb5-15" tabindex="-1"></a></span>
<span id="cb5-16"><a aria-hidden="true" href="#cb5-16" tabindex="-1"></a>  <span class=
"co">// Use shop domain to get env values</span></span>
<span id="cb5-17"><a aria-hidden="true" href="#cb5-17" tabindex="-1"></a>  <span class=
"kw">const</span> domain <span class="op">=</span> <span class="fu">cleanDomain</span>(shop <span class=
"op">||</span> shopDomain)<span class="op">;</span></span>
<span id="cb5-18"><a aria-hidden="true" href="#cb5-18" tabindex="-1"></a>  Shopify<span class="op">.</span><span class=
"at">Context</span><span class="op">.</span><span class="fu">initialize</span>({</span>
<span id="cb5-19"><a aria-hidden="true" href="#cb5-19" tabindex="-1"></a>    <span class=
"dt">API_KEY</span><span class="op">:</span> <span class="bu">process</span><span class="op">.</span><span class=
"at">env</span>[<span class="vs">`SHOPIFY_API_KEY_</span><span class="sc"></span><span class="vs">`</span>]<span class=
"op">,</span></span>
<span id="cb5-20"><a aria-hidden="true" href="#cb5-20" tabindex="-1"></a>    <span class=
"dt">API_SECRET_KEY</span><span class="op">:</span> <span class="bu">process</span><span class=
"op">.</span><span class="at">env</span>[<span class="vs">`SHOPIFY_API_SECRET_</span><span class=
"sc"></span><span class="vs">`</span>]<span class="op">,</span></span>
<span id="cb5-21"><a aria-hidden="true" href="#cb5-21" tabindex="-1"></a>    <span class="dt">SCOPES</span><span class=
"op">:</span> <span class="bu">process</span><span class="op">.</span><span class="at">env</span><span class=
"op">.</span><span class="at">SCOPES</span><span class="op">.</span><span class="fu">split</span>(<span class=
"st">","</span>)<span class="op">,</span></span>
<span id="cb5-22"><a aria-hidden="true" href="#cb5-22" tabindex="-1"></a>    <span class=
"dt">HOST_NAME</span><span class="op">:</span> <span class="bu">process</span><span class="op">.</span><span class=
"at">env</span><span class="op">.</span><span class="at">HOST</span><span class="op">.</span><span class=
"fu">replace</span>(<span class="ss">/https:</span><span class="sc">\/\/</span><span class="ss">/</span><span class=
"op">,</span> <span class="st">""</span>)<span class="op">,</span></span>
<span id="cb5-23"><a aria-hidden="true" href="#cb5-23" tabindex="-1"></a>    <span class=
"dt">API_VERSION</span><span class="op">:</span> ApiVersion<span class="op">.</span><span class=
"at">October20</span><span class="op">,</span></span>
<span id="cb5-24"><a aria-hidden="true" href="#cb5-24" tabindex="-1"></a>    <span class=
"dt">IS_EMBEDDED_APP</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb5-25"><a aria-hidden="true" href="#cb5-25" tabindex="-1"></a>    <span class=
"dt">SESSION_STORAGE</span><span class="op">:</span> <span class="kw">new</span> Shopify<span class=
"op">.</span><span class="at">Session</span><span class="op">.</span><span class=
"fu">MemorySessionStorage</span>()<span class="op">,</span></span>
<span id="cb5-26"><a aria-hidden="true" href="#cb5-26" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb5-27"><a aria-hidden="true" href="#cb5-27" tabindex="-1"></a></span>
<span id="cb5-28"><a aria-hidden="true" href="#cb5-28" tabindex="-1"></a>  <span class="cf">return</span> <span class=
"cf">await</span> <span class="fu">next</span>()<span class="op">;</span></span>
<span id="cb5-29"><a aria-hidden="true" href="#cb5-29" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb5-30"><a aria-hidden="true" href="#cb5-30" tabindex="-1"></a></span>
<span id="cb5-31"><a aria-hidden="true" href="#cb5-31" tabindex="-1"></a><span class="im">export</span> <span class=
"im">default</span> shopContext<span class="op">;</span></span></code></pre>
              </div>

              <p>
                Now open your <code>server/server.js</code> file and include the middleware for use on every backend
                route. Example:
              </p>

              <div class="sourceCode" id="cb6">
                <pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb6-1"><a aria-hidden=
                "true" href="#cb6-1" tabindex="-1"></a># <span class="op">./</span>server<span class=
                "op">/</span>server<span class="op">.</span><span class="at">js</span></span>
<span id="cb6-2"><a aria-hidden="true" href="#cb6-2" tabindex="-1"></a><span class="co">// ...</span></span>
<span id="cb6-3"><a aria-hidden="true" href="#cb6-3" tabindex="-1"></a><span class=
"im">import</span> shopEnv <span class="im">from</span> <span class=
"st">"../src/server/middleware/shopEnv"</span><span class="op">;</span></span>
<span id="cb6-4"><a aria-hidden="true" href="#cb6-4" tabindex="-1"></a><span class="co">// ...</span></span>
<span id="cb6-5"><a aria-hidden="true" href="#cb6-5" tabindex="-1"></a></span>
<span id="cb6-6"><a aria-hidden="true" href="#cb6-6" tabindex="-1"></a><span class="co">// Example</span></span>
<span id="cb6-7"><a aria-hidden="true" href="#cb6-7" tabindex="-1"></a>router<span class="op">.</span><span class=
"fu">post</span>(</span>
<span id="cb6-8"><a aria-hidden="true" href="#cb6-8" tabindex="-1"></a>    <span class=
"st">"/customer/register"</span><span class="op">,</span></span>
<span id="cb6-9"><a aria-hidden="true" href="#cb6-9" tabindex="-1"></a>    shopContext<span class=
"op">,</span> # <span class="op">&lt;----</span> middleware</span>
<span id="cb6-10"><a aria-hidden="true" href="#cb6-10" tabindex="-1"></a>    shopState<span class="op">,</span></span>
<span id="cb6-11"><a aria-hidden="true" href="#cb6-11" tabindex="-1"></a>    <span class=
"fu">errWrap</span>(customerRegister)</span>
<span id="cb6-12"><a aria-hidden="true" href="#cb6-12" tabindex="-1"></a>)<span class="op">;</span></span>
<span id="cb6-13"><a aria-hidden="true" href="#cb6-13" tabindex="-1"></a></span>
<span id="cb6-14"><a aria-hidden="true" href="#cb6-14" tabindex="-1"></a><span class="co">// Example</span></span>
<span id="cb6-15"><a aria-hidden="true" href="#cb6-15" tabindex="-1"></a>router<span class="op">.</span><span class=
"fu">get</span>(</span>
<span id="cb6-16"><a aria-hidden="true" href="#cb6-16" tabindex="-1"></a>    <span class="st">"(.*)"</span><span class=
"op">,</span></span>
<span id="cb6-17"><a aria-hidden="true" href="#cb6-17" tabindex="-1"></a>    shopContext<span class=
"op">,</span> # <span class="op">&lt;----</span> middleware</span>
<span id="cb6-18"><a aria-hidden="true" href="#cb6-18" tabindex="-1"></a>    <span class=
"fu">defaultRequest</span>(handle)</span>
<span id="cb6-19"><a aria-hidden="true" href="#cb6-19" tabindex="-1"></a>)<span class="op">;</span></span></code></pre>
              </div>

              <p>
                As well, remove the default <code>Shopify.Context</code> declaration in the <code>server.js</code>
                file.
              </p>

              <p>
                Now, all API requests in your handlers will use the shop’s API key and secret.
              </p>

              <h4 id="verifyhmac">
                VerifyHmac
              </h4>

              <p>
                This middleware file for Koa will verify HMAC strings.
              </p>

              <div class="sourceCode" id="cb7">
                <pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb7-1"><a aria-hidden=
                "true" href="#cb7-1" tabindex="-1"></a># <span class="op">./</span>src<span class=
                "op">/</span>server<span class="op">/</span>middleare<span class="op">/</span>verifyHmac<span class=
                "op">.</span><span class="at">js</span></span>
<span id="cb7-2"><a aria-hidden="true" href="#cb7-2" tabindex="-1"></a><span class=
"im">import</span> Shopify <span class="im">from</span> <span class="st">"@shopify/shopify-api"</span><span class=
"op">;</span></span>
<span id="cb7-3"><a aria-hidden="true" href="#cb7-3" tabindex="-1"></a><span class=
"im">import</span> { generateLocalHmac<span class="op">,</span> cleanDomain } <span class="im">from</span> <span class=
"st">"../../services/utils"</span><span class="op">;</span></span>
<span id="cb7-4"><a aria-hidden="true" href="#cb7-4" tabindex="-1"></a></span>
<span id="cb7-5"><a aria-hidden="true" href="#cb7-5" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb7-6"><a aria-hidden="true" href="#cb7-6" tabindex="-1"></a><span class="co"> * Verify HMAC.</span></span>
<span id="cb7-7"><a aria-hidden="true" href="#cb7-7" tabindex="-1"></a><span class="co"> * </span><span class=
"an">@param</span><span class="co"> </span><span class="cv">{*}</span><span class=
"co"> ctx The Koa context.</span></span>
<span id="cb7-8"><a aria-hidden="true" href="#cb7-8" tabindex="-1"></a><span class="co"> * </span><span class=
"an">@param</span><span class="co"> </span><span class="cv">{*}</span><span class=
"co"> next The next code to hit.</span></span>
<span id="cb7-9"><a aria-hidden="true" href="#cb7-9" tabindex="-1"></a><span class="co"> * </span><span class=
"an">@returns</span><span class="co"> any</span></span>
<span id="cb7-10"><a aria-hidden="true" href="#cb7-10" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb7-11"><a aria-hidden="true" href="#cb7-11" tabindex="-1"></a><span class=
"kw">const</span> verifyHmac <span class="op">=</span> <span class="kw">async</span> (ctx<span class=
"op">,</span> next) <span class="kw">=&gt;</span> {</span>
<span id="cb7-12"><a aria-hidden="true" href="#cb7-12" tabindex="-1"></a>  <span class=
"co">// Remove HMAC</span></span>
<span id="cb7-13"><a aria-hidden="true" href="#cb7-13" tabindex="-1"></a>  <span class=
"kw">const</span> { query } <span class="op">=</span> ctx<span class="op">;</span></span>
<span id="cb7-14"><a aria-hidden="true" href="#cb7-14" tabindex="-1"></a>  <span class=
"kw">const</span> { hmac<span class="op">,</span> shop } <span class="op">=</span> query<span class=
"op">;</span></span>
<span id="cb7-15"><a aria-hidden="true" href="#cb7-15" tabindex="-1"></a>  <span class=
"kw">delete</span> ctx<span class="op">.</span><span class="at">query</span><span class="op">.</span><span class=
"at">hmac</span><span class="op">;</span></span>
<span id="cb7-16"><a aria-hidden="true" href="#cb7-16" tabindex="-1"></a></span>
<span id="cb7-17"><a aria-hidden="true" href="#cb7-17" tabindex="-1"></a>  <span class=
"co">// Generate a local HMAC</span></span>
<span id="cb7-18"><a aria-hidden="true" href="#cb7-18" tabindex="-1"></a>  <span class=
"kw">const</span> domain <span class="op">=</span> <span class="fu">cleanDomain</span>(shop)<span class=
"op">;</span></span>
<span id="cb7-19"><a aria-hidden="true" href="#cb7-19" tabindex="-1"></a>  <span class=
"kw">const</span> localHmac <span class="op">=</span> <span class="fu">generateLocalHmac</span>(</span>
<span id="cb7-20"><a aria-hidden="true" href="#cb7-20" tabindex="-1"></a>    query<span class="op">,</span></span>
<span id="cb7-21"><a aria-hidden="true" href="#cb7-21" tabindex="-1"></a>    <span class=
"bu">process</span><span class="op">.</span><span class="at">env</span>[<span class=
"vs">`SHOPIFY_API_SECRET_</span><span class="sc"></span><span class="vs">`</span>]</span>
<span id="cb7-22"><a aria-hidden="true" href="#cb7-22" tabindex="-1"></a>  )<span class="op">;</span></span>
<span id="cb7-23"><a aria-hidden="true" href="#cb7-23" tabindex="-1"></a></span>
<span id="cb7-24"><a aria-hidden="true" href="#cb7-24" tabindex="-1"></a>  <span class=
"co">// Validate the HMAC</span></span>
<span id="cb7-25"><a aria-hidden="true" href="#cb7-25" tabindex="-1"></a>  <span class=
"kw">const</span> valid <span class="op">=</span> Shopify<span class="op">.</span><span class=
"at">Utils</span><span class="op">.</span><span class="fu">safeCompare</span>(hmac<span class=
"op">,</span> localHmac)<span class="op">;</span></span>
<span id="cb7-26"><a aria-hidden="true" href="#cb7-26" tabindex="-1"></a>  <span class="cf">if</span> (<span class=
"op">!</span>valid) {</span>
<span id="cb7-27"><a aria-hidden="true" href="#cb7-27" tabindex="-1"></a>    <span class=
"co">// HMAC did not validate</span></span>
<span id="cb7-28"><a aria-hidden="true" href="#cb7-28" tabindex="-1"></a>    <span class=
"co">// const err = createError("ValidationError");</span></span>
<span id="cb7-29"><a aria-hidden="true" href="#cb7-29" tabindex="-1"></a>    <span class=
"co">// throw new err("Invalid HMAC");</span></span>
<span id="cb7-30"><a aria-hidden="true" href="#cb7-30" tabindex="-1"></a>    ctx<span class="op">.</span><span class=
"at">status</span> <span class="op">=</span> <span class="dv">400</span><span class="op">;</span></span>
<span id="cb7-31"><a aria-hidden="true" href="#cb7-31" tabindex="-1"></a>    <span class="cf">return</span><span class=
"op">;</span></span>
<span id="cb7-32"><a aria-hidden="true" href="#cb7-32" tabindex="-1"></a>  }</span>
<span id="cb7-33"><a aria-hidden="true" href="#cb7-33" tabindex="-1"></a></span>
<span id="cb7-34"><a aria-hidden="true" href="#cb7-34" tabindex="-1"></a>  <span class="cf">return</span> <span class=
"cf">await</span> <span class="fu">next</span>()<span class="op">;</span></span>
<span id="cb7-35"><a aria-hidden="true" href="#cb7-35" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb7-36"><a aria-hidden="true" href="#cb7-36" tabindex="-1"></a></span>
<span id="cb7-37"><a aria-hidden="true" href="#cb7-37" tabindex="-1"></a><span class="im">export</span> <span class=
"im">default</span> verifyHmac<span class="op">;</span></span></code></pre>
              </div>

              <h3 id="handler-addition">
                Handler Addition
              </h3>

              <p>
                We need to pass the proper API key to AppBridge.
              </p>

              <div class="sourceCode" id="cb8">
                <pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb8-1"><a aria-hidden=
                "true" href="#cb8-1" tabindex="-1"></a># <span class="op">./</span>src<span class=
                "op">/</span>server<span class="op">/</span>handlers<span class="op">/</span>backend<span class=
                "op">/</span>appbridge<span class="op">.</span><span class="at">js</span></span>
<span id="cb8-2"><a aria-hidden="true" href="#cb8-2" tabindex="-1"></a><span class=
"im">import</span> { cleanDomain } <span class="im">from</span> <span class=
"st">"../../../services/utils"</span><span class="op">;</span></span>
<span id="cb8-3"><a aria-hidden="true" href="#cb8-3" tabindex="-1"></a></span>
<span id="cb8-4"><a aria-hidden="true" href="#cb8-4" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb8-5"><a aria-hidden="true" href="#cb8-5" tabindex="-1"></a><span class=
"co"> * AppBridge setup.</span></span>
<span id="cb8-6"><a aria-hidden="true" href="#cb8-6" tabindex="-1"></a><span class="co"> * </span><span class=
"an">@param</span><span class="co"> </span><span class="cv">{*}</span><span class="co"> ctx Koa context.</span></span>
<span id="cb8-7"><a aria-hidden="true" href="#cb8-7" tabindex="-1"></a><span class="co"> * </span><span class=
"an">@returns</span><span class="co"> void</span></span>
<span id="cb8-8"><a aria-hidden="true" href="#cb8-8" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb8-9"><a aria-hidden="true" href="#cb8-9" tabindex="-1"></a><span class=
"kw">const</span> appbridge <span class="op">=</span> <span class="kw">async</span> (ctx) <span class=
"kw">=&gt;</span> {</span>
<span id="cb8-10"><a aria-hidden="true" href="#cb8-10" tabindex="-1"></a>  <span class=
"co">// Get the API key for the shop</span></span>
<span id="cb8-11"><a aria-hidden="true" href="#cb8-11" tabindex="-1"></a>  <span class=
"kw">const</span> domain <span class="op">=</span> <span class="fu">cleanDomain</span>(ctx<span class=
"op">.</span><span class="at">query</span><span class="op">.</span><span class="at">shop</span>)<span class=
"op">;</span></span>
<span id="cb8-12"><a aria-hidden="true" href="#cb8-12" tabindex="-1"></a>  <span class=
"kw">const</span> key <span class="op">=</span> <span class="bu">process</span><span class="op">.</span><span class=
"at">env</span>[<span class="vs">`SHOPIFY_API_KEY_</span><span class="sc"></span><span class="vs">`</span>]<span class=
"op">;</span></span>
<span id="cb8-13"><a aria-hidden="true" href="#cb8-13" tabindex="-1"></a></span>
<span id="cb8-14"><a aria-hidden="true" href="#cb8-14" tabindex="-1"></a>  ctx<span class="op">.</span><span class=
"at">status</span> <span class="op">=</span> <span class="dv">200</span><span class="op">;</span></span>
<span id="cb8-15"><a aria-hidden="true" href="#cb8-15" tabindex="-1"></a>  ctx<span class="op">.</span><span class=
"at">body</span> <span class="op">=</span> { key }<span class="op">;</span></span>
<span id="cb8-16"><a aria-hidden="true" href="#cb8-16" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb8-17"><a aria-hidden="true" href="#cb8-17" tabindex="-1"></a></span>
<span id="cb8-18"><a aria-hidden="true" href="#cb8-18" tabindex="-1"></a><span class="im">export</span> <span class=
"im">default</span> appbridge<span class="op">;</span></span></code></pre>
              </div>

              <p>
                Now open <code>server/server.js</code> to add a route for this as well as the <code>VerifyHmac</code>
                middleware.
              </p>

              <div class="sourceCode" id="cb9">
                <pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb9-1"><a aria-hidden=
                "true" href="#cb9-1" tabindex="-1"></a># <span class="op">./</span>server<span class=
                "op">/</span>server<span class="op">.</span><span class="at">js</span></span>
<span id="cb9-2"><a aria-hidden="true" href="#cb9-2" tabindex="-1"></a><span class="co">// ...</span></span>
<span id="cb9-3"><a aria-hidden="true" href="#cb9-3" tabindex="-1"></a><span class=
"im">import</span> appbridge <span class="im">from</span> <span class=
"st">"../src/server/handlers/backend/appbridge"</span><span class="op">;</span></span>
<span id="cb9-4"><a aria-hidden="true" href="#cb9-4" tabindex="-1"></a><span class=
"im">import</span> verifyHmac <span class="im">from</span> <span class=
"st">"../src/server/middleware/verifyHmac"</span><span class="op">;</span></span>
<span id="cb9-5"><a aria-hidden="true" href="#cb9-5" tabindex="-1"></a><span class="co">// ...</span></span>
<span id="cb9-6"><a aria-hidden="true" href="#cb9-6" tabindex="-1"></a></span>
<span id="cb9-7"><a aria-hidden="true" href="#cb9-7" tabindex="-1"></a><span class=
"co">// Route: AppBridge API key</span></span>
<span id="cb9-8"><a aria-hidden="true" href="#cb9-8" tabindex="-1"></a>router<span class="op">.</span><span class=
"fu">get</span>(<span class="st">"/_appbridge"</span><span class="op">,</span> verifyHmac<span class=
"op">,</span> appbridge)<span class="op">;</span></span></code></pre>
              </div>

              <h3 id="appbridge-integration">
                AppBridge Integration
              </h3>

              <p>
                Now that we have our backend handler to verify the HMAC and return back an API key for the shop, we
                need to tap into the existing AppBridge setup to complete the integration.
              </p>

              <p>
                Open <code>_app.js</code>, and look for the <code>MyApp.getInitialProps</code>, it will look something
                like this:
              </p>

              <div class="sourceCode" id="cb10">
                <pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb10-1"><a aria-hidden=
                "true" href="#cb10-1" tabindex="-1"></a>MyApp<span class="op">.</span><span class=
                "at">getInitialProps</span> <span class="op">=</span> <span class=
                "kw">async</span> ({ ctx }) <span class="kw">=&gt;</span> {</span>
<span id="cb10-2"><a aria-hidden="true" href="#cb10-2" tabindex="-1"></a>  <span class="cf">return</span> {</span>
<span id="cb10-3"><a aria-hidden="true" href="#cb10-3" tabindex="-1"></a>    <span class="dt">host</span><span class=
"op">:</span> ctx<span class="op">.</span><span class="at">query</span><span class="op">.</span><span class=
"at">host</span><span class="op">,</span></span>
<span id="cb10-4"><a aria-hidden="true" href="#cb10-4" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb10-5"><a aria-hidden="true" href="#cb10-5" tabindex="-1"></a>}<span class="op">;</span></span></code></pre>
              </div>

              <p>
                We will now modify it to this:
              </p>

              <div class="sourceCode" id="cb11">
                <pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb11-1"><a aria-hidden=
                "true" href="#cb11-1" tabindex="-1"></a>MyApp<span class="op">.</span><span class=
                "at">getInitialProps</span> <span class="op">=</span> <span class=
                "kw">async</span> ({ ctx }) <span class="kw">=&gt;</span> {</span>
<span id="cb11-2"><a aria-hidden="true" href="#cb11-2" tabindex="-1"></a>  <span class="kw">let</span> key <span class=
"op">=</span> <span class="st">""</span><span class="op">;</span></span>
<span id="cb11-3"><a aria-hidden="true" href="#cb11-3" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb11-4"><a aria-hidden="true" href="#cb11-4" tabindex="-1"></a>    <span class=
"co">// Get the API key for the shop</span></span>
<span id="cb11-5"><a aria-hidden="true" href="#cb11-5" tabindex="-1"></a>    <span class=
"kw">const</span> query <span class="op">=</span> <span class="kw">new</span> <span class=
"fu">URLSearchParams</span>(ctx<span class="op">.</span><span class="at">query</span>)<span class=
"op">.</span><span class="fu">toString</span>()<span class="op">;</span></span>
<span id="cb11-6"><a aria-hidden="true" href="#cb11-6" tabindex="-1"></a>    <span class=
"kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class=
"fu">fetch</span>(<span class="vs">`</span><span class="sc"></span><span class="vs">/_appbridge?</span><span class=
"sc"></span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb11-7"><a aria-hidden="true" href="#cb11-7" tabindex="-1"></a>    <span class=
"kw">const</span> body <span class="op">=</span> <span class="cf">await</span> response<span class=
"op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb11-8"><a aria-hidden="true" href="#cb11-8" tabindex="-1"></a>    key <span class=
"op">=</span> body<span class="op">.</span><span class="at">key</span><span class="op">;</span></span>
<span id="cb11-9"><a aria-hidden="true" href="#cb11-9" tabindex="-1"></a>  } <span class="cf">catch</span> (e) {</span>
<span id="cb11-10"><a aria-hidden="true" href="#cb11-10" tabindex="-1"></a>    <span class=
"co">// This usually will only fire when running `npm run build`</span></span>
<span id="cb11-11"><a aria-hidden="true" href="#cb11-11" tabindex="-1"></a>    <span class=
"bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class=
"st">"Unable to obtain AppBridge key."</span>)<span class="op">;</span></span>
<span id="cb11-12"><a aria-hidden="true" href="#cb11-12" tabindex="-1"></a>  }</span>
<span id="cb11-13"><a aria-hidden="true" href="#cb11-13" tabindex="-1"></a></span>
<span id="cb11-14"><a aria-hidden="true" href="#cb11-14" tabindex="-1"></a>  <span class="cf">return</span> {</span>
<span id="cb11-15"><a aria-hidden="true" href="#cb11-15" tabindex="-1"></a>    <span class=
"dt">apiKey</span><span class="op">:</span> key<span class="op">,</span></span>
<span id="cb11-16"><a aria-hidden="true" href="#cb11-16" tabindex="-1"></a>    <span class="dt">host</span><span class=
"op">:</span> ctx<span class="op">.</span><span class="at">query</span><span class="op">.</span><span class=
"at">host</span><span class="op">,</span></span>
<span id="cb11-17"><a aria-hidden="true" href="#cb11-17" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb11-18"><a aria-hidden="true" href="#cb11-18" tabindex="-1"></a>}<span class=
"op">;</span></span></code></pre>
              </div>

              <p>
                Next, modify your <code>MyApp</code> class, which will look something like this:
              </p>

              <div class="sourceCode" id="cb12">
                <pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb12-1"><a aria-hidden=
                "true" href="#cb12-1" tabindex="-1"></a><span class="kw">class</span> MyApp <span class=
                "kw">extends</span> App {</span>
<span id="cb12-2"><a aria-hidden="true" href="#cb12-2" tabindex="-1"></a>  <span class="fu">render</span>() {</span>
<span id="cb12-3"><a aria-hidden="true" href="#cb12-3" tabindex="-1"></a>    <span class=
"kw">const</span> { Component<span class="op">,</span> pageProps<span class="op">,</span> host } <span class=
"op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">props</span><span class=
"op">;</span></span>
<span id="cb12-4"><a aria-hidden="true" href="#cb12-4" tabindex="-1"></a></span>
<span id="cb12-5"><a aria-hidden="true" href="#cb12-5" tabindex="-1"></a>    <span class="cf">return</span> (</span>
<span id="cb12-6"><a aria-hidden="true" href="#cb12-6" tabindex="-1"></a>      <span class=
"op">&lt;</span>AppProvider i18n<span class="op">=</span>{translations}<span class="op">&gt;</span></span>
<span id="cb12-7"><a aria-hidden="true" href="#cb12-7" tabindex="-1"></a>        <span class=
"op">&lt;</span>Provider</span>
<span id="cb12-8"><a aria-hidden="true" href="#cb12-8" tabindex="-1"></a>          config<span class=
"op">=</span>{ {</span>
<span id="cb12-9"><a aria-hidden="true" href="#cb12-9" tabindex="-1"></a>            <span class=
"dt">apiKey</span><span class="op">:</span> API_KEY<span class="op">,</span></span>
<span id="cb12-10"><a aria-hidden="true" href="#cb12-10" tabindex="-1"></a>            <span class=
"dt">host</span><span class="op">:</span> host<span class="op">,</span></span>
<span id="cb12-11"><a aria-hidden="true" href="#cb12-11" tabindex="-1"></a>            <span class=
"dt">forceRedirect</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb12-12"><a aria-hidden="true" href="#cb12-12" tabindex="-1"></a>          } }</span>
<span id="cb12-13"><a aria-hidden="true" href="#cb12-13" tabindex="-1"></a>        <span class="op">&gt;</span></span>
<span id="cb12-14"><a aria-hidden="true" href="#cb12-14" tabindex="-1"></a>          <span class=
"op">&lt;</span>MyProvider Component<span class="op">=</span>{Component} {<span class=
"op">...</span>pageProps} <span class="op">/&gt;</span></span>
<span id="cb12-15"><a aria-hidden="true" href="#cb12-15" tabindex="-1"></a>        <span class=
"op">&lt;/</span>Provider<span class="op">&gt;</span></span>
<span id="cb12-16"><a aria-hidden="true" href="#cb12-16" tabindex="-1"></a>      <span class=
"op">&lt;/</span>AppProvider<span class="op">&gt;</span></span>
<span id="cb12-17"><a aria-hidden="true" href="#cb12-17" tabindex="-1"></a>    )<span class="op">;</span></span>
<span id="cb12-18"><a aria-hidden="true" href="#cb12-18" tabindex="-1"></a>  }</span>
<span id="cb12-19"><a aria-hidden="true" href="#cb12-19" tabindex="-1"></a>}</span></code></pre>
              </div>

              <p>
                We will now modify it to this, to use the new prop:
              </p>

              <div class="sourceCode" id="cb13">
                <pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb13-1"><a aria-hidden=
                "true" href="#cb13-1" tabindex="-1"></a><span class="kw">class</span> MyApp <span class=
                "kw">extends</span> App {</span>
<span id="cb13-2"><a aria-hidden="true" href="#cb13-2" tabindex="-1"></a>  <span class="fu">render</span>() {</span>
<span id="cb13-3"><a aria-hidden="true" href="#cb13-3" tabindex="-1"></a>    <span class=
"kw">const</span> { Component<span class="op">,</span> pageProps<span class="op">,</span> host<span class=
"op">,</span> apiKey } <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class=
"at">props</span><span class="op">;</span></span>
<span id="cb13-4"><a aria-hidden="true" href="#cb13-4" tabindex="-1"></a></span>
<span id="cb13-5"><a aria-hidden="true" href="#cb13-5" tabindex="-1"></a>    <span class="cf">return</span> (</span>
<span id="cb13-6"><a aria-hidden="true" href="#cb13-6" tabindex="-1"></a>      <span class=
"op">&lt;</span>AppProvider i18n<span class="op">=</span>{translations}<span class="op">&gt;</span></span>
<span id="cb13-7"><a aria-hidden="true" href="#cb13-7" tabindex="-1"></a>        <span class=
"op">&lt;</span>Provider</span>
<span id="cb13-8"><a aria-hidden="true" href="#cb13-8" tabindex="-1"></a>          config<span class=
"op">=</span>{ {</span>
<span id="cb13-9"><a aria-hidden="true" href="#cb13-9" tabindex="-1"></a>            <span class=
"dt">apiKey</span><span class="op">:</span> apiKey<span class="op">,</span></span>
<span id="cb13-10"><a aria-hidden="true" href="#cb13-10" tabindex="-1"></a>            <span class=
"dt">host</span><span class="op">:</span> host<span class="op">,</span></span>
<span id="cb13-11"><a aria-hidden="true" href="#cb13-11" tabindex="-1"></a>            <span class=
"dt">forceRedirect</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb13-12"><a aria-hidden="true" href="#cb13-12" tabindex="-1"></a>          } }</span>
<span id="cb13-13"><a aria-hidden="true" href="#cb13-13" tabindex="-1"></a>        <span class="op">&gt;</span></span>
<span id="cb13-14"><a aria-hidden="true" href="#cb13-14" tabindex="-1"></a>          <span class=
"op">&lt;</span>MyProvider Component<span class="op">=</span>{Component} {<span class=
"op">...</span>pageProps} <span class="op">/&gt;</span></span>
<span id="cb13-15"><a aria-hidden="true" href="#cb13-15" tabindex="-1"></a>        <span class=
"op">&lt;/</span>Provider<span class="op">&gt;</span></span>
<span id="cb13-16"><a aria-hidden="true" href="#cb13-16" tabindex="-1"></a>      <span class=
"op">&lt;/</span>AppProvider<span class="op">&gt;</span></span>
<span id="cb13-17"><a aria-hidden="true" href="#cb13-17" tabindex="-1"></a>    )<span class="op">;</span></span>
<span id="cb13-18"><a aria-hidden="true" href="#cb13-18" tabindex="-1"></a>  }</span>
<span id="cb13-19"><a aria-hidden="true" href="#cb13-19" tabindex="-1"></a>}</span></code></pre>
              </div>

              <p>
                You’re now completed.
              </p>

              <h2 id="conculsion">
                Conculsion
              </h2>

              <p>
                In two parts, we created middleware to handle modifying/setting up the <code>Shopify.Context</code>
                object and also created a handler to verify the shop’s request and supply back an API key to pass to
                AppBridge.
              </p>

              <p>
                The code in this post can certainly be improved upon, but its a good start for someone looking to add
                multi-tenant support to a custom app setup.
              </p>
            </div>
          </div>
        </div>
      </article>

      <section class="tab tab--appendix">
        <div class="tab__title tab__title--short">
          Appendix
        </div>

        <div class="tab__container">
          <div class="tab__content">
            <div class="content-container">
              <p class="warning warning--post">
                This post is 3 years old and may contain outdated information.
              </p>

              <p>
                Copyright under <a class="sources__link" href="https://creativecommons.org/licenses/by/4.0/" rel=
                "noopener" target="_blank">CC-4.0</a>.
              </p>

              <p>
                Available in the following alternative formats: <span class="sources"><a class="sources__link" href=
                "/shopify-node-app-custom-multi-tenant/index.md">MD</a>&nbsp;&nbsp;/&nbsp;&nbsp;<a class=
                "sources__link" href=
                "/shopify-node-app-custom-multi-tenant/index.txt">TXT</a>&nbsp;&nbsp;/&nbsp;&nbsp;<a class=
                "sources__link" href="" onclick="window.print(); return false;">PDF</a></span>
              </p>
            </div>
          </div>
        </div>
      </section>
    </main>

    <footer class="site-tail container">
      <div class="site-tail__avatar">
        <a href="/about"><img alt="Ty King" class="site-tail__avatar-img" src="/assets/images/me.jpg"></a>
      </div>

      <div class="site-tail__about">
        <h3 class="site-tail__author">
          <a href="/about">Ty King</a>
        </h3>

        <p class="site-tail__blurb">
          A self-taught, seasoned, and versatile developer from Newfoundland. <span>Crafting innovative solutions with
          care and expertise.</span>
        </p>
      </div>

      <div class="site-tail__blurb-ext">
        <p class="site-tail__blurb">
          Crafting innovative solutions with care and expertise.
        </p>
      </div>

      <div class="site-tail__links">
        <a class="button button--strong" href="https://github.com/gnikyt" rel="noopener" target=
        "_blank">Github</a><a class="button button--strong" href="https://linkedin.com/in/gnikyt" rel="noopener"
        target="_blank">LinkedIn</a><a class="button button--strong" href="/assets/files/cv.pdf" target=
        "_blank">CV</a><a class="button button--strong" href="/rss.xml" target="_blank">RSS</a>
      </div>
    </footer>

    <ul class="site-colors container container--short">
      <li class="site-colors__color color--a">
      </li>

      <li class="site-colors__color color--b">
      </li>

      <li class="site-colors__color color--c">
      </li>

      <li class="site-colors__color color--d">
      </li>

      <li class="site-colors__color color--e">
      </li>

      <li class="site-colors__color color--f">
      </li>

      <li class="site-colors__color color--g">
      </li>

      <li class="site-colors__color color--h">
      </li>
    </ul>
  </body>
</html>
